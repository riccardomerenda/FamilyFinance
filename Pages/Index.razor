@page "/"
@using System.Text
@using System.Text.Json
@inject FinanceService Finance
@inject IJSRuntime JS
@inject IStringLocalizer<SharedResource> L

<h3>@L["DashboardTitle"]</h3>

@if (_latest is null) { 
    <div class="alert alert-warning">
        @L["NoDataMessage"] <a href="snapshots/new">@L["CreateFirstSnapshot"]</a>.
    </div>
}
else {
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link @(Tab=="dash"?"active":"")" @onclick='()=>Tab="dash"'>@L["TabDashboard"]</button></li>
        <li class="nav-item"><button class="nav-link @(Tab=="inv"?"active":"")" @onclick='()=>Tab="inv"'>@L["TabInvestments"]</button></li>
        <li class="nav-item"><button class="nav-link @(Tab=="int"?"active":"")" @onclick='()=>Tab="int"'>@L["TabInterests"]</button></li>
        <li class="nav-item"><button class="nav-link @(Tab=="exp"?"active":"")" @onclick='()=>Tab="exp"'>@L["TabExport"]</button></li>
    </ul>

    @if (Tab == "dash") {
        <div class="row g-3 mb-4">
            <div class="col-md-4"><div class="card p-3 shadow-sm border-primary"><h5>@L["CurrentTotal"]</h5><h2 class="text-primary">@_t.CurrentTotal.ToString("N0") €</h2><small class="text-muted">@L["LiquidityPlusInvestments"]</small></div></div>
            <div class="col-md-4"><div class="card p-3 shadow-sm border-success"><h5>@L["Projected"]</h5><h2 class="text-success">@_t.ProjectedTotal.ToString("N0") €</h2><small class="text-muted">@L["IncludingCredits"]</small></div></div>
            <div class="col-md-4"><div class="card p-3 shadow-sm"><h5>@L["NetWorthTotal"]</h5><h2>@_t.GrandTotal.ToString("N0") €</h2><small class="text-muted">@L["IncludingPension"]</small></div></div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card p-3 mb-3">
                    <h6>@L["WealthTrend"]</h6>
                    <Chart CanvasId="trend" Config="@_trendConfig" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 mb-3">
                    <h6>@L["Composition"]</h6>
                    <Chart CanvasId="comp" Config="@_compConfig" />
                </div>
            </div>
        </div>
        
        <div class="row">
             <div class="col-md-6">
                <h6>@L["PendingCredits"]</h6>
                <ul class="list-group">
                @foreach(var r in _latest.Receivables.Where(x=>x.Status == ReceivableStatus.Open)) {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        @r.Description
                        <span class="badge bg-primary rounded-pill">@r.Amount.ToString("N0") €</span>
                    </li>
                }
                </ul>
            </div>
        </div>
    }
    @if (Tab == "inv") {
        <div class="row">
            <div class="col-md-6">
                <table class="table table-striped">
                    <thead><tr><th>@L["Asset"]</th><th class="text-end">@L["Value"]</th></tr></thead>
                    <tbody>@foreach(var i in _latest.Investments){<tr><td>@i.Name</td><td class="text-end">@i.Value.ToString("N2")</td></tr>}</tbody>
                </table>
            </div>
            <div class="col-md-6"><Chart CanvasId="invPie" Config="@_invPieConfig" /></div>
        </div>
    }
    @if (Tab == "int") {
        <Chart CanvasId="intBar" Config="@_intBarConfig" />
        <table class="table mt-3">
            <thead><tr><th>@L["Account"]</th><th class="text-end">@L["AccumulatedInterests"]</th></tr></thead>
            <tbody>@foreach(var l in _latest.Lines.Where(x=>x.Account.IsInterest)){<tr><td>@l.Account.Name</td><td class="text-end">@l.Amount.ToString("N2")</td></tr>}</tbody>
        </table>
    }
    @if (Tab == "exp") {
        <div class="card p-4">
            <h5>@L["ExportData"]</h5>
            <div class="mt-3">
                <button class="btn btn-primary me-2" @onclick="ExportJson">@L["DownloadBackupJson"]</button>
                <button class="btn btn-secondary" @onclick="ExportCsv">@L["DownloadCsvExcel"]</button>
            </div>
        </div>
    }
}

@code {
    string Tab = "dash";
    Snapshot? _latest;
    Totals _t = new(0,0,0,0,0,0,0,0);
    object _trendConfig = new{}, _compConfig = new{}, _invPieConfig = new{}, _intBarConfig = new{};

    protected override async Task OnInitializedAsync() {
        _latest = await Finance.GetLatestSnapshotAsync();
        if (_latest != null) {
            _t = await Finance.CalculateTotalsAsync(_latest);
            await BuildCharts();
        }
    }

    async Task BuildCharts() {
        var all = await Finance.GetSnapshotsAsync();
        var full = new List<(string d, decimal v)>();
        foreach(var s in all.OrderBy(x=>x.SnapshotDate)) {
            var sn = await Finance.GetSnapshotAsync(s.Id);
            var t = await Finance.CalculateTotalsAsync(sn!);
            full.Add((s.SnapshotDate.ToString("MM/yy"), t.GrandTotal));
        }

        _trendConfig = new { type="line", data=new{ labels=full.Select(x=>x.d), datasets=new[]{ new{ label=L["ChartTotal"].Value, data=full.Select(x=>x.v), borderColor="#36A2EB", tension=0.2 } } } };
        _compConfig = new { type="doughnut", data=new{ labels=new[]{L["ChartLiquidity"].Value, L["ChartInvestments"].Value, L["ChartCredits"].Value, L["ChartPension"].Value}, datasets=new[]{ new{ data=new[]{_t.Liquidity, _t.Investments, _t.CreditsOpen, _t.PensionInsurance}, backgroundColor=new[]{"#FF6384","#36A2EB","#FFCE56","#4BC0C0"} } } } };
        _invPieConfig = new { type="pie", data=new{ labels=_latest!.Investments.Select(x=>x.Name), datasets=new[]{ new{ data=_latest.Investments.Select(x=>x.Value) } } } };
        
        var intLines = _latest.Lines.Where(l=>l.Account.IsInterest).ToList();
        _intBarConfig = new { type="bar", data=new{ labels=intLines.Select(x=>x.Account.Name), datasets=new[]{ new{ label=L["ChartInterests"].Value, data=intLines.Select(x=>x.Amount) } } } };
    }

    async Task ExportJson() {
        var all = await Finance.GetSnapshotsAsync();
        var data = new List<object>();
        foreach(var s in all) { var snap = await Finance.GetSnapshotAsync(s.Id); if(snap != null) data.Add(snap); }
        var json = JsonSerializer.Serialize(data);
        await JS.InvokeVoidAsync("downloadFile", "backup.json", "application/json", Convert.ToBase64String(Encoding.UTF8.GetBytes(json)));
    }
    
    async Task ExportCsv() {
        var all = await Finance.GetSnapshotsAsync();
        var sb = new StringBuilder("Data,Liquidità,Investimenti,Crediti,Pensione,Totale\n");
        foreach(var s in all) {
            var sn = await Finance.GetSnapshotAsync(s.Id);
            var t = await Finance.CalculateTotalsAsync(sn!);
            sb.AppendLine($"{s.SnapshotDate:yyyy-MM-dd},{t.Liquidity},{t.Investments},{t.CreditsOpen},{t.PensionInsurance},{t.GrandTotal}");
        }
        await JS.InvokeVoidAsync("downloadFile", "export.csv", "text/csv", Convert.ToBase64String(Encoding.UTF8.GetBytes(sb.ToString())));
    }
}
