@using System.Globalization
@inject NavigationManager Nav

<div class="dropdown d-inline-block">
    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        üåê @GetCurrentLanguageFlag()
    </button>
    <ul class="dropdown-menu" aria-labelledby="languageDropdown">
        @foreach (var culture in SupportedCultures)
        {
            <li>
                <a class="dropdown-item @(IsCurrentCulture(culture.Code) ? "active" : "")" 
                   href="@GetCultureChangeUrl(culture.Code)">
                    @culture.Flag @culture.Name
                </a>
            </li>
        }
    </ul>
</div>

@code {
    private static readonly (string Code, string Name, string Flag)[] SupportedCultures = new[]
    {
        ("it-IT", "Italiano", "üáÆüáπ"),
        ("en-US", "English", "üá¨üáß")
    };

    private string GetCurrentLanguageFlag()
    {
        var current = CultureInfo.CurrentUICulture.Name;
        var culture = SupportedCultures.FirstOrDefault(c => c.Code == current);
        return culture.Flag ?? "üáÆüáπ";
    }

    private bool IsCurrentCulture(string code) => CultureInfo.CurrentUICulture.Name == code;

    private string GetCultureChangeUrl(string cultureCode)
    {
        // Get current path from NavigationManager
        var currentUri = Nav.ToAbsoluteUri(Nav.Uri);
        var currentPath = currentUri.PathAndQuery;
        
        // Ensure it starts with /
        if (string.IsNullOrEmpty(currentPath) || !currentPath.StartsWith('/'))
        {
            currentPath = "/";
        }
        
        return $"/Culture/Set?culture={cultureCode}&redirectUri={Uri.EscapeDataString(currentPath)}";
    }
}
