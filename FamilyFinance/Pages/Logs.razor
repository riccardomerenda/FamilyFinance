@page "/logs"
@using FamilyFinance.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject LogService Log
@inject IStringLocalizer<SharedResource> L
@inject AuthenticationStateProvider AuthState
@inject AuthService Auth
@inject NavigationManager Nav
@attribute [Authorize(Roles = "Admin")]

<PageTitle>@L["SystemLogs"] - FamilyFinance</PageTitle>

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 animate-in">
        <div>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-600 to-slate-800 flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">@L["SystemLogs"]</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">@L["SystemLogsDesc"]</p>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button @onclick="Refresh" class="flex items-center gap-2 px-4 py-2.5 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                @L["Refresh"]
            </button>
            <div class="relative">
                <button @onclick="ToggleClearMenu" class="flex items-center gap-2 px-4 py-2.5 bg-red-500/10 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 rounded-xl hover:bg-red-500/20 transition-all font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    @L["ClearLogs"]
                </button>
                @if (_showClearMenu)
                {
                    <div class="absolute right-0 mt-2 w-56 rounded-xl shadow-2xl border z-50 overflow-hidden
                                bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-700">
                        <button @onclick="ClearToday" class="w-full px-4 py-3 text-left text-sm font-medium flex items-center gap-3
                                                           text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            @L["ClearTodayLogs"]
                        </button>
                        <div class="border-t border-gray-200 dark:border-gray-700"></div>
                        <button @onclick="ClearAll" class="w-full px-4 py-3 text-left text-sm font-medium flex items-center gap-3
                                                          text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            @L["ClearAllLogs"]
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 animate-in delay-1">
        <div class="bento-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">@_logFiles.Count</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">@L["LogFilesTotal"]</p>
                </div>
            </div>
        </div>
        <div class="bento-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">@_infoCount</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Info</p>
                </div>
            </div>
        </div>
        <div class="bento-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-amber-600 dark:text-amber-400">@_warnCount</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Warning</p>
                </div>
            </div>
        </div>
        <div class="bento-card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-red-600 dark:text-red-400">@_errorCount</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Error</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bento-card p-4 mb-4 animate-in delay-2">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">@L["Filter"]:</span>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" @bind="_showInfo" @bind:after="ApplyFilter" class="w-4 h-4 rounded border-gray-300 text-blue-500 focus:ring-blue-500" />
                <span class="text-sm text-gray-700 dark:text-gray-300">Info (@_infoCount)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" @bind="_showWarn" @bind:after="ApplyFilter" class="w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500" />
                <span class="text-sm text-amber-600 dark:text-amber-400">Warning (@_warnCount)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" @bind="_showError" @bind:after="ApplyFilter" class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-500" />
                <span class="text-sm text-red-600 dark:text-red-400">Error (@_errorCount)</span>
            </label>
            <div class="flex-1"></div>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" @bind="_hideSystemLogs" @bind:after="ApplyFilter" class="w-4 h-4 rounded border-gray-300 text-primary-500 focus:ring-primary-500" />
                <span class="text-sm text-gray-700 dark:text-gray-300">@L["HideSystemLogs"]</span>
            </label>
        </div>
    </div>

    <!-- Log File Info -->
    <div class="flex items-center justify-between mb-2 animate-in delay-2">
        <p class="text-xs text-gray-500 dark:text-gray-400 font-mono">@_logPath</p>
        <p class="text-xs text-gray-400">@_filteredLogs.Count @L["Of"] @_allLogs.Count @L["LogEntries"]</p>
    </div>

    <!-- Log Console -->
    <div class="bento-card bg-slate-900 dark:bg-slate-950 p-1 overflow-hidden animate-in delay-3">
        <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
            @if (_filteredLogs.Count == 0)
            {
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <p class="text-slate-500">@L["NoLogs"]</p>
                </div>
            }
            else
            {
                <table class="w-full text-sm font-mono">
                    <tbody>
                        @foreach (var log in _filteredLogs)
                        {
                            var (level, time, source, message) = ParseLog(log);
                            var levelClass = GetLevelClass(level);
                            <tr class="hover:bg-slate-800/50 border-b border-slate-800/50 group">
                                <td class="px-2 py-1.5 text-slate-500 whitespace-nowrap text-xs">@time</td>
                                <td class="px-2 py-1.5 whitespace-nowrap">
                                    <span class="px-1.5 py-0.5 rounded text-xs font-semibold @levelClass">@level</span>
                                </td>
                                <td class="px-2 py-1.5 text-slate-400 whitespace-nowrap text-xs max-w-[150px] truncate" title="@source">@source</td>
                                <td class="px-2 py-1.5 text-slate-300 break-all">@message</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <!-- Admin Notice -->
    <div class="mt-4 p-3 rounded-xl bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 animate-in delay-4">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-slate-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
            <div class="text-sm text-slate-600 dark:text-slate-400">
                <p class="font-medium text-slate-700 dark:text-slate-300">@L["AdminOnlyPage"]</p>
                <p>@L["AdminOnlyPageDesc"]</p>
            </div>
        </div>
    </div>
</div>

@code {
    List<string> _allLogs = new();
    List<string> _filteredLogs = new();
    List<string> _logFiles = new();
    string _logPath = "";
    bool _showClearMenu = false;
    
    // Filters
    bool _showInfo = true;
    bool _showWarn = true;
    bool _showError = true;
    bool _hideSystemLogs = true;
    
    // Stats
    int _infoCount = 0;
    int _warnCount = 0;
    int _errorCount = 0;
    
    // System log sources to hide
    readonly string[] _systemSources = new[] {
        "Microsoft.EntityFrameworkCore",
        "Microsoft.AspNetCore",
        "Microsoft.Hosting"
    };

    protected override void OnInitialized()
    {
        Refresh();
        _logPath = Log.GetLogFilePath();
    }

    void Refresh()
    {
        _allLogs = Log.GetRecentLogs(500);
        _logFiles = Log.GetLogFiles();
        _showClearMenu = false;
        CountLogs();
        ApplyFilter();
    }
    
    void CountLogs()
    {
        _infoCount = _allLogs.Count(l => l.Contains("[INF]"));
        _warnCount = _allLogs.Count(l => l.Contains("[WRN]") || l.Contains("[WARN]"));
        _errorCount = _allLogs.Count(l => l.Contains("[ERR]") || l.Contains("[ERROR]"));
    }
    
    void ApplyFilter()
    {
        _filteredLogs = _allLogs.Where(log =>
        {
            // Level filter
            if (!_showInfo && log.Contains("[INF]")) return false;
            if (!_showWarn && (log.Contains("[WRN]") || log.Contains("[WARN]"))) return false;
            if (!_showError && (log.Contains("[ERR]") || log.Contains("[ERROR]"))) return false;
            
            // System logs filter
            if (_hideSystemLogs && _systemSources.Any(s => log.Contains(s))) return false;
            
            return true;
        }).ToList();
    }
    
    void ToggleClearMenu()
    {
        _showClearMenu = !_showClearMenu;
    }

    void ClearToday()
    {
        Log.ClearTodayLogs();
        Refresh();
    }

    void ClearAll()
    {
        Log.ClearAllLogs();
        Refresh();
    }
    
    (string level, string time, string source, string message) ParseLog(string log)
    {
        // Format: 2025-12-22 11:00:49.872 +00:00 [INF] (SourceContext) Message
        try
        {
            var parts = log.Split(' ');
            if (parts.Length < 5) return ("INF", "", "", log);
            
            var time = $"{parts[0]} {parts[1].Split('.')[0]}"; // Date + time without ms
            
            // Find level
            var levelStart = log.IndexOf('[');
            var levelEnd = log.IndexOf(']', levelStart);
            var level = levelStart >= 0 && levelEnd > levelStart 
                ? log.Substring(levelStart + 1, levelEnd - levelStart - 1) 
                : "INF";
            
            // Find source
            var sourceStart = log.IndexOf('(', levelEnd);
            var sourceEnd = log.IndexOf(')', sourceStart);
            var source = sourceStart >= 0 && sourceEnd > sourceStart
                ? log.Substring(sourceStart + 1, sourceEnd - sourceStart - 1)
                : "";
            
            // Shorten source
            if (source.Contains('.'))
            {
                var sourceParts = source.Split('.');
                source = sourceParts[^1]; // Last part
            }
            
            // Get message
            var message = sourceEnd > 0 && sourceEnd + 2 < log.Length
                ? log.Substring(sourceEnd + 2)
                : log;
            
            return (level, time, source, message);
        }
        catch
        {
            return ("INF", "", "", log);
        }
    }

    string GetLevelClass(string level)
    {
        return level switch
        {
            "ERR" or "ERROR" => "bg-red-500/20 text-red-400",
            "WRN" or "WARN" => "bg-amber-500/20 text-amber-400",
            "INF" or "INFO" => "bg-blue-500/20 text-blue-400",
            "DBG" or "DEBUG" => "bg-slate-500/20 text-slate-400",
            _ => "bg-slate-500/20 text-slate-400"
        };
    }
}
