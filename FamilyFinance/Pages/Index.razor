@page "/"
@using System.Text
@using System.Text.Json
@using System.IO
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using FamilyFinance.Services
@inject FinanceService Finance
@inject IJSRuntime JS
@inject IStringLocalizer<SharedResource> L
@inject AuthenticationStateProvider AuthState
@inject FamilyFinance.Services.AuthService Auth
@inject NotificationService Toast

@if (_latest is null && !_showImportPanel)
{
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary-500/20 to-accent-500/20 flex items-center justify-center mb-6">
            <svg class="w-12 h-12 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">@L["NoDataMessage"]</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6">@L["CreateFirstSnapshot"]</p>
        
        <div class="flex flex-col sm:flex-row gap-4">
            <a href="snapshots/new" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                @L["NewSnapshot"]
            </a>
            
            <button @onclick="() => _showImportPanel = true" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all shadow-lg shadow-emerald-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                @L["ImportBackup"]
            </button>
        </div>
    </div>
}
else if (_latest is null && _showImportPanel)
{
    <!-- Import Panel (Empty State) -->
    <div class="max-w-2xl mx-auto">
        <button @onclick="() => { _showImportPanel = false; CancelImport(); }" class="mb-6 inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            @L["Back"]
        </button>
        
        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 rounded-xl bg-white/20 flex items-center justify-center">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold">@L["ImportData"]</h3>
                    <p class="text-emerald-100 text-sm">@L["ImportDataDesc"]</p>
                </div>
            </div>
            
            @if (_importPreview == null && _importResult == null)
            {
                <label class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-emerald-50 transition-all cursor-pointer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    @L["SelectBackupFile"]
                    <InputFile OnChange="OnFileSelected" accept=".json" class="hidden" />
                </label>
            }
            
            @if (_importPreview != null)
            {
                <!-- Preview -->
                <div class="bg-white/10 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-medium">@L["BackupPreview"]</span>
                        @if (_importPreview.ExportDate.HasValue)
                        {
                            <span class="text-sm text-emerald-200">@_importPreview.ExportDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                        }
                    </div>
                    
                    @if (!_importPreview.IsValid)
                    {
                        <div class="bg-red-500/20 border border-red-300/30 rounded-lg p-3 text-sm">
                            ⚠️ @_importPreview.Error
                        </div>
                    }
                    else
                    {
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                            <div class="bg-white/10 rounded-lg p-3">
                                <p class="text-emerald-200">@L["Accounts"]</p>
                                <p class="text-lg font-bold">@_importPreview.TotalAccounts</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <p class="text-emerald-200">@L["Portfolios"]</p>
                                <p class="text-lg font-bold">@_importPreview.TotalPortfolios</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <p class="text-emerald-200">@L["Goals"]</p>
                                <p class="text-lg font-bold">@_importPreview.TotalGoals</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <p class="text-emerald-200">@L["BudgetCategories"]</p>
                                <p class="text-lg font-bold">@_importPreview.TotalBudgetCategories</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <p class="text-emerald-200">@L["Snapshots"]</p>
                                <p class="text-lg font-bold">@_importPreview.TotalSnapshots</p>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="flex gap-3">
                    @if (_importPreview.IsValid)
                    {
                        <button @onclick="ExecuteImport" disabled="@_isImporting" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-emerald-50 transition-all disabled:opacity-50">
                            @if (_isImporting)
                            {
                                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>@L["Importing"]...</span>
                            }
                            else
                            {
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span>@L["ConfirmImport"]</span>
                            }
                        </button>
                    }
                    <button @onclick="CancelImport" class="px-4 py-3 bg-white/20 text-white font-semibold rounded-xl hover:bg-white/30 transition-all">
                        @L["Cancel"]
                    </button>
                </div>
            }
            
            @if (_importResult != null)
            {
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        @if (_importResult.Success)
                        {
                            <svg class="w-6 h-6 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-bold text-green-300">@L["ImportSuccess"]</span>
                        }
                        else
                        {
                            <svg class="w-6 h-6 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-bold text-red-300">@L["ImportFailed"]</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(_importResult.Error))
                    {
                        <p class="text-sm text-red-200">@_importResult.Error</p>
                    }
                    else
                    {
                        <p class="text-sm text-emerald-100">@_importResult.AccountsImported @L["Accounts"], @_importResult.BudgetCategoriesImported @L["BudgetCategories"], @_importResult.SnapshotsImported @L["Snapshots"] @L["Imported"]</p>
                    }
                    
                    <button @onclick="async () => { CancelImport(); _showImportPanel = false; await OnInitializedAsync(); }" class="mt-4 w-full px-4 py-2 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-emerald-50 transition-all">
                        @L["Continue"]
                    </button>
                </div>
            }
        </div>
    </div>
}
else
{
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-6">
        <button class="tab-btn @(Tab=="dash" ? "tab-btn-active" : "")" @onclick='() => Tab = "dash"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
            </svg>
            @L["TabDashboard"]
        </button>
        <button class="tab-btn @(Tab=="inv" ? "tab-btn-active" : "")" @onclick='() => Tab = "inv"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            @L["TabInvestments"]
        </button>
        <button class="tab-btn @(Tab=="int" ? "tab-btn-active" : "")" @onclick='() => Tab = "int"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            @L["TabInterests"]
        </button>
        <button class="tab-btn @(Tab=="pen" ? "tab-btn-active" : "")" @onclick='() => Tab = "pen"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            @L["TabPension"]
        </button>
        <button class="tab-btn @(Tab=="bud" ? "tab-btn-active" : "")" @onclick='() => Tab = "bud"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            @L["TabBudget"]
        </button>
        <button class="tab-btn @(Tab=="exp" ? "tab-btn-active" : "")" @onclick='() => Tab = "exp"'>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            @L["TabExport"]
        </button>
    </div>

    @if (Tab == "dash")
    {
        <!-- Bento Grid Dashboard -->
        <div class="grid grid-cols-12 gap-4 lg:gap-6">
            
            <!-- HERO: Net Worth Card (Large) -->
            <div class="col-span-12 lg:col-span-5 bento-card hero-gradient glow-primary p-6 lg:p-8 text-white animate-in">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <p class="text-white/70 text-sm font-medium uppercase tracking-wider">@L["NetWorthTotal"]</p>
                        <h2 class="text-4xl lg:text-5xl font-extrabold mt-2 money">@_t.ProjectedTotal.ToString("N0") €</h2>
                        <p class="text-white/60 text-sm mt-2">@L["LiquidityPlusInvestmentsCredits"]</p>
                    </div>
                    <div class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                @if (_t.PensionInsuranceValue > 0)
                {
                    <div class="pt-4 border-t border-white/20">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <span class="text-white/70 text-sm">@L["IncludingPension"]:</span>
                            <span class="font-bold money">@_t.GrandTotal.ToString("N0") €</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Liquidity Card -->
            <div class="col-span-6 lg:col-span-4 bento-card p-5 animate-in delay-1">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">@L["ChartLiquidity"]</span>
                </div>
                <p class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white money">@_t.Liquidity.ToString("N0") €</p>
                <p class="text-xs text-gray-400 mt-1">+ @_t.InterestLiquidity.ToString("N0") € @L["ChartInterests"]</p>
            </div>

            <!-- Investments Card -->
            <div class="col-span-6 lg:col-span-3 bento-card p-5 animate-in delay-2">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">@L["ChartInvestments"]</span>
                </div>
                <p class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white money">@_t.InvestmentsValue.ToString("N0") €</p>
                <p class="text-xs mt-1 @(_t.InvestmentsGainLoss >= 0 ? "text-emerald-500" : "text-red-500") font-medium">
                    @(_t.InvestmentsGainLoss >= 0 ? "+" : "")@_t.InvestmentsGainLoss.ToString("N0") € (@(_t.InvestmentsGainLossPercent >= 0 ? "+" : "")@_t.InvestmentsGainLossPercent.ToString("N1")%)
                </p>
            </div>

            <!-- Trend Chart (Large) -->
            <div class="col-span-12 lg:col-span-8 bento-card p-5 lg:p-6 animate-in delay-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["WealthTrend"]</h3>
                    <a href="/projections" class="text-xs font-medium text-primary-500 hover:text-primary-600 flex items-center gap-1">
                        @L["Projections"]
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
                <div class="h-56 lg:h-64">
                    <Chart CanvasId="trend" Config="@_trendConfig" />
                </div>
            </div>

            <!-- Composition Donut -->
            <div class="col-span-12 lg:col-span-4 bento-card p-5 lg:p-6 animate-in delay-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["Composition"]</h3>
                <div class="h-48 lg:h-56">
                    <Chart CanvasId="comp" Config="@_compConfig" />
                </div>
            </div>

            <!-- Goals Widget -->
            @if (_goals != null && _goals.Any())
            {
                <div class="col-span-12 lg:col-span-6 bento-card p-5 lg:p-6 animate-in delay-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["Goals"]</h3>
                        <a href="/goals" class="text-xs font-medium text-primary-500 hover:text-primary-600 flex items-center gap-1">
                            @L["Edit"]
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </a>
                    </div>
                    <div class="space-y-4">
                        @foreach (var goal in _goals.Take(3))
                        {
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">@goal.Name</span>
                                    <span class="text-xs font-semibold @(goal.IsCompleted ? "text-emerald-500" : "text-gray-500 dark:text-gray-400")">
                                        @goal.ProgressPercent.ToString("N0")%
                                    </span>
                                </div>
                                <div class="h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full progress-animated @(goal.IsCompleted ? "bg-gradient-to-r from-emerald-500 to-teal-400" : "bg-gradient-to-r from-primary-500 to-accent-500")" 
                                         style="width: @Math.Min(100, goal.ProgressPercent)%"></div>
                                </div>
                                <div class="flex items-center justify-between text-xs text-gray-400">
                                    <span class="money">@goal.AllocatedAmount.ToString("N0") € / @goal.Target.ToString("N0") €</span>
                                    @if (!goal.IsCompleted && goal.Deadline.HasValue)
                                    {
                                        <span>@goal.DeadlineDisplay</span>
                                    }
                                    else if (goal.IsCompleted)
                                    {
                                        <span class="text-emerald-500">✓ @L["GoalCompleted"]</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Quick Actions / Budget Widget -->
            <div class="col-span-12 lg:col-span-6 bento-card p-5 lg:p-6 animate-in delay-5">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["Actions"]</h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="/snapshots/new" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gradient-to-br from-primary-500/10 to-primary-600/10 hover:from-primary-500/20 hover:to-primary-600/20 transition-all group">
                        <div class="w-10 h-10 rounded-xl bg-primary-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">@L["NewSnapshot"]</span>
                    </a>
                    <a href="/accounts" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/10 hover:from-blue-500/20 hover:to-blue-600/20 transition-all group">
                        <div class="w-10 h-10 rounded-xl bg-blue-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">@L["Accounts"]</span>
                    </a>
                    <a href="/goals" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gradient-to-br from-emerald-500/10 to-emerald-600/10 hover:from-emerald-500/20 hover:to-emerald-600/20 transition-all group">
                        <div class="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">@L["Goals"]</span>
                    </a>
                    <a href="/compare" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gradient-to-br from-amber-500/10 to-amber-600/10 hover:from-amber-500/20 hover:to-amber-600/20 transition-all group">
                        <div class="w-10 h-10 rounded-xl bg-amber-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">@L["Compare"]</span>
                    </a>
                </div>
            </div>

            <!-- Pending Credits -->
            @if (_latest!.Receivables.Any(x => x.Status == ReceivableStatus.Open))
            {
                <div class="col-span-12 bento-card p-5 lg:p-6 animate-in delay-5">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["PendingCredits"]</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        @foreach (var r in _latest.Receivables.Where(x => x.Status == ReceivableStatus.Open))
                        {
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border border-amber-100 dark:border-amber-800/30">
                                <span class="font-medium text-gray-700 dark:text-gray-300 text-sm">@r.Description</span>
                                <span class="px-3 py-1 bg-amber-500 text-white rounded-full text-sm font-bold money">
                                    @r.Amount.ToString("N0") €
                                </span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }

    @if (Tab == "inv")
    {
        <!-- Investment Performance Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["CostBasis"]</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">@_t.InvestmentsCost.ToString("N0") €</p>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["CurrentValue"]</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">@_t.InvestmentsValue.ToString("N0") €</p>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["GainLoss"]</p>
                <p class="text-xl font-bold @(_t.InvestmentsGainLoss >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                    @(_t.InvestmentsGainLoss >= 0 ? "+" : "")@_t.InvestmentsGainLoss.ToString("N0") €
                </p>
            </div>
            <div class="@(_t.InvestmentsGainLoss >= 0 ? "bg-green-500" : "bg-red-500") rounded-xl p-4 text-white">
                <p class="text-xs text-white/80 mb-1">@L["Performance"]</p>
                <p class="text-xl font-bold">
                    @(_t.InvestmentsGainLossPercent >= 0 ? "+" : "")@_t.InvestmentsGainLossPercent.ToString("N2")%
                </p>
            </div>
        </div>

        <!-- Portfolio Cards (Collapsible) -->
        <div class="space-y-3">
            @foreach (var group in _latest!.Investments.GroupBy(i => i.Portfolio).OrderBy(g => g.Key?.Name ?? "zzz"))
            {
                var portfolio = group.Key;
                var portfolioId = portfolio?.Id;
                var isExpanded = _expandedPortfolios.Contains(portfolioId);
                var pCost = group.Sum(x => x.CostBasis);
                var pValue = group.Sum(x => x.Value);
                var pGl = pValue - pCost;
                var pPct = pCost > 0 ? (pGl / pCost) * 100 : 0;
                var color = portfolio?.Color ?? "#6b7280";
                var assetCount = group.Count();
                
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                    <!-- Portfolio Header (Clickable) -->
                    <button @onclick="() => TogglePortfolio(portfolioId)" class="w-full p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800/30 transition-colors cursor-pointer" style="background: linear-gradient(135deg, @(color)15, transparent)">
                        <div class="flex items-center gap-3">
                            <!-- Expand/Collapse Arrow -->
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-gray-100 dark:bg-gray-800 transition-transform duration-200 @(isExpanded ? "rotate-90" : "")">
                                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white" style="background-color: @color">
                                @if (portfolio != null)
                                {
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                }
                                else
                                {
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                }
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800 dark:text-gray-200">@(portfolio?.Name ?? L["NoPortfolio"])</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    @assetCount asset@(assetCount != 1 ? "s" : "")
                                    @if (portfolio?.TimeHorizonYears != null) { <span class="mx-1">•</span><span>@portfolio.TimeHorizonYears @L["Years"]</span> }
                                    @if (portfolio?.TargetYear != null) { <span>→ @portfolio.TargetYear</span> }
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">@pValue.ToString("N0") €</p>
                            <p class="text-sm font-medium @(pGl >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                @(pGl >= 0 ? "+" : "")@pGl.ToString("N0") € (@(pPct >= 0 ? "+" : "")@pPct.ToString("N2")%)
                            </p>
                        </div>
                    </button>
                    
                    <!-- Assets List (Collapsible) -->
                    @if (isExpanded)
                    {
                        <div class="border-t border-gray-200 dark:border-gray-800 divide-y divide-gray-100 dark:divide-gray-800 bg-gray-50/50 dark:bg-gray-800/20">
                            @foreach (var i in group)
                            {
                                <div class="p-4 flex items-center justify-between hover:bg-white dark:hover:bg-gray-800/50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm" style="background-color: @color">
                                            @i.Name[..Math.Min(2, i.Name.Length)]
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-700 dark:text-gray-300">@i.Name</span>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">@L["CostBasis"]: @i.CostBasis.ToString("N2") €</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-gray-900 dark:text-white">@i.Value.ToString("N2") €</p>
                                        <p class="text-sm @(i.GainLoss >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                            @(i.GainLoss >= 0 ? "+" : "")@i.GainLoss.ToString("N2") € (@(i.GainLossPercent >= 0 ? "+" : "")@i.GainLossPercent.ToString("N2")%)
                                        </p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Pie Chart -->
        <div class="mt-6 bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["Composition"]</h3>
            <div class="h-80">
                <Chart CanvasId="invPie" Config="@_invPieConfig" />
            </div>
        </div>
    }

    @if (Tab == "int")
    {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["AccumulatedInterests"]</h3>
                <div class="space-y-3">
                    @foreach (var l in _latest!.Lines.Where(x => x.Account.IsInterest))
                    {
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                            <span class="font-medium text-gray-700 dark:text-gray-300">@l.Account.Name</span>
                            <span class="font-semibold text-green-600 dark:text-green-400">+@l.Amount.ToString("N2") €</span>
                        </div>
                    }
                </div>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <div class="h-80">
                    <Chart CanvasId="intBar" Config="@_intBarConfig" />
                </div>
            </div>
        </div>
    }

    @if (Tab == "pen")
    {
        var pensionLines = _latest!.Lines.Where(x => x.Account.Category == AccountCategory.Pension).ToList();
        var insuranceLines = _latest.Lines.Where(x => x.Account.Category == AccountCategory.Insurance).ToList();
        var allPensionLines = _latest.Lines.Where(x => x.Account.Category is AccountCategory.Pension or AccountCategory.Insurance).ToList();
        
        <!-- Performance Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["Contributions"]</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">@_t.PensionInsuranceContrib.ToString("N0") €</p>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["CurrentValue"]</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">@_t.PensionInsuranceValue.ToString("N0") €</p>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["GainLoss"]</p>
                <p class="text-xl font-bold @(_t.PensionInsuranceGainLoss >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                    @(_t.PensionInsuranceGainLoss >= 0 ? "+" : "")@_t.PensionInsuranceGainLoss.ToString("N0") €
                </p>
            </div>
            <div class="@(_t.PensionInsuranceGainLoss >= 0 ? "bg-green-500" : "bg-red-500") rounded-xl p-4 text-white">
                <p class="text-xs text-white/80 mb-1">@L["Performance"]</p>
                <p class="text-xl font-bold">
                    @(_t.PensionInsuranceGainLossPercent >= 0 ? "+" : "")@_t.PensionInsuranceGainLossPercent.ToString("N2")%
                </p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Pension -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["PensionFunds"]</h3>
                </div>
                @if (pensionLines.Any())
                {
                    <div class="space-y-3">
                        @foreach (var l in pensionLines)
                        {
                            <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">@l.Account.Name</span>
                                    <span class="font-semibold text-purple-600 dark:text-purple-400">@l.Amount.ToString("N2") €</span>
                                </div>
                                @if (l.ContributionBasis > 0)
                                {
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500 dark:text-gray-400">@L["Contributions"]: @l.ContributionBasis.ToString("N2") €</span>
                                        <span class="font-medium @(l.GainLoss >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                            @(l.GainLoss >= 0 ? "+" : "")@l.GainLoss.ToString("N2") € (@(l.GainLossPercent >= 0 ? "+" : "")@l.GainLossPercent.ToString("N2")%)
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">@L["NoPensionAccounts"]</p>
                }
            </div>

            <!-- Insurance -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["InsurancePolicies"]</h3>
                </div>
                @if (insuranceLines.Any())
                {
                    <div class="space-y-3">
                        @foreach (var l in insuranceLines)
                        {
                            <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">@l.Account.Name</span>
                                    <span class="font-semibold text-green-600 dark:text-green-400">@l.Amount.ToString("N2") €</span>
                                </div>
                                @if (l.ContributionBasis > 0)
                                {
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500 dark:text-gray-400">@L["Contributions"]: @l.ContributionBasis.ToString("N2") €</span>
                                        <span class="font-medium @(l.GainLoss >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                            @(l.GainLoss >= 0 ? "+" : "")@l.GainLoss.ToString("N2") € (@(l.GainLossPercent >= 0 ? "+" : "")@l.GainLossPercent.ToString("N2")%)
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">@L["NoInsuranceAccounts"]</p>
                }
            </div>
        </div>

        <!-- Total Summary Card -->
        <div class="mt-6 bg-gradient-to-r from-purple-500 to-green-500 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm font-medium">@L["TotalPensionInsurance"]</p>
                    <p class="text-3xl font-bold mt-1">@_t.PensionInsuranceValue.ToString("N2") €</p>
                    @if (_t.PensionInsuranceContrib > 0)
                    {
                        <p class="text-sm mt-1 text-white/80">
                            @L["Contributions"]: @_t.PensionInsuranceContrib.ToString("N0") € → 
                            <span class="font-semibold">@(_t.PensionInsuranceGainLoss >= 0 ? "+" : "")@_t.PensionInsuranceGainLoss.ToString("N0") € (@(_t.PensionInsuranceGainLossPercent >= 0 ? "+" : "")@_t.PensionInsuranceGainLossPercent.ToString("N2")%)</span>
                        </p>
                    }
                </div>
                <div class="w-16 h-16 rounded-2xl bg-white/20 flex items-center justify-center">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
            </div>
        </div>
    }

    @if (Tab == "bud")
    {
        @if (_budgetSummary != null)
        {
            <!-- Budget Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["TotalMonthlyBudget"]</p>
                    <p class="text-xl font-bold text-gray-900 dark:text-white">@_budgetSummary.TotalBudget.ToString("N0") €</p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["Spent"]</p>
                    <p class="text-xl font-bold text-gray-900 dark:text-white">@_budgetSummary.TotalSpent.ToString("N0") €</p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">@L["Remaining"]</p>
                    <p class="text-xl font-bold @(_budgetSummary.Difference >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                        @(_budgetSummary.Difference >= 0 ? "+" : "")@_budgetSummary.Difference.ToString("N0") €
                    </p>
                </div>
                <div class="@(_budgetSummary.Difference >= 0 ? "bg-green-500" : "bg-red-500") rounded-xl p-4 text-white">
                    <p class="text-xs text-white/80 mb-1">@L["Performance"]</p>
                    <p class="text-xl font-bold">@_budgetSummary.PercentUsed.ToString("N0")% @L["OfBudget"]</p>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800 dark:text-gray-200">@L["BudgetVsActual"]</h2>
                    <a href="/budget" class="text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700">@L["ManageCategories"]</a>
                </div>
                <div class="p-4 space-y-3">
                    @foreach (var cat in _budgetSummary.Categories.Where(c => c.Budget > 0 || c.Spent > 0))
                    {
                        <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" style="background-color: @(cat.Color)20">
                                        @cat.Icon
                                    </div>
                                    <span class="font-medium text-gray-700 dark:text-gray-300">@cat.Name</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold @(cat.IsOverBudget ? "text-red-600 dark:text-red-400" : "text-gray-900 dark:text-white")">
                                        @cat.Spent.ToString("N0") €
                                    </span>
                                    @if (cat.Budget > 0)
                                    {
                                        <span class="text-gray-500 dark:text-gray-400"> / @cat.Budget.ToString("N0") €</span>
                                    }
                                </div>
                            </div>
                            @if (cat.Budget > 0)
                            {
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all @(cat.IsOverBudget ? "bg-red-500" : cat.PercentUsed > 80 ? "bg-amber-500" : "bg-green-500")" 
                                         style="width: @Math.Min(100, cat.PercentUsed)%"></div>
                                </div>
                                <div class="flex items-center justify-between mt-1 text-xs">
                                    <span class="text-gray-500 dark:text-gray-400">@cat.PercentUsed.ToString("N0")%</span>
                                    <span class="@(cat.Difference >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                        @(cat.Difference >= 0 ? "+" : "")@cat.Difference.ToString("N0") € @(cat.Difference >= 0 ? L["Remaining"] : L["OverBudget"])
                                    </span>
                                </div>
                            }
                        </div>
                    }
                    
                    @if (!_budgetSummary.Categories.Any(c => c.Budget > 0 || c.Spent > 0))
                    {
                        <div class="text-center py-8">
                            <p class="text-gray-500 dark:text-gray-400 mb-4">@L["NoExpenseCategories"]</p>
                            <a href="/budget" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-500 text-white font-semibold rounded-xl hover:bg-primary-600 transition-all">
                                @L["ConfigureBudget"]
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-16">
                <div class="w-20 h-20 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">@L["NoBudgetCategories"]</h3>
                <p class="text-gray-500 dark:text-gray-400 mb-6">@L["NoBudgetCategoriesDesc"]</p>
                <a href="/budget" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    @L["ConfigureBudget"]
                </a>
            </div>
        }
    }

    @if (Tab == "exp")
    {
        <div class="max-w-4xl mx-auto">
            <!-- Import Section -->
            <div class="mb-8 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-14 h-14 rounded-xl bg-white/20 flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">@L["ImportData"]</h3>
                        <p class="text-emerald-100 text-sm">@L["ImportDataDesc"]</p>
                    </div>
                </div>
                
                @if (_importPreview == null && _importResult == null)
                {
                    <label class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-emerald-50 transition-all cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        @L["SelectBackupFile"]
                        <InputFile OnChange="OnFileSelected" accept=".json" class="hidden" />
                    </label>
                }
                
                @if (_importPreview != null)
                {
                    <!-- Preview -->
                    <div class="bg-white/10 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium">@L["BackupPreview"]</span>
                            @if (_importPreview.ExportDate.HasValue)
                            {
                                <span class="text-sm text-emerald-200">@_importPreview.ExportDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                            }
                        </div>
                        
                        @if (!_importPreview.IsValid)
                        {
                            <div class="bg-red-500/20 border border-red-300/30 rounded-lg p-3 text-sm">
                                ⚠️ @_importPreview.Error
                            </div>
                        }
                        else
                        {
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                                <div class="bg-white/10 rounded-lg p-3">
                                    <p class="text-emerald-200">@L["Accounts"]</p>
                                    <p class="text-lg font-bold">@_importPreview.TotalAccounts</p>
                                    <p class="text-xs text-emerald-200">
                                        <span class="text-green-300">+@_importPreview.NewAccounts @L["New"]</span>
                                        @if (_importPreview.ExistingAccounts > 0) { <span> · @_importPreview.ExistingAccounts @L["Existing"]</span> }
                                    </p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3">
                                    <p class="text-emerald-200">@L["Portfolios"]</p>
                                    <p class="text-lg font-bold">@_importPreview.TotalPortfolios</p>
                                    <p class="text-xs text-emerald-200">
                                        <span class="text-green-300">+@_importPreview.NewPortfolios @L["New"]</span>
                                        @if (_importPreview.ExistingPortfolios > 0) { <span> · @_importPreview.ExistingPortfolios @L["Existing"]</span> }
                                    </p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3">
                                    <p class="text-emerald-200">@L["Goals"]</p>
                                    <p class="text-lg font-bold">@_importPreview.TotalGoals</p>
                                    <p class="text-xs text-emerald-200">
                                        <span class="text-green-300">+@_importPreview.NewGoals @L["New"]</span>
                                        @if (_importPreview.ExistingGoals > 0) { <span> · @_importPreview.ExistingGoals @L["Existing"]</span> }
                                    </p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3">
                                    <p class="text-emerald-200">@L["BudgetCategories"]</p>
                                    <p class="text-lg font-bold">@_importPreview.TotalBudgetCategories</p>
                                    <p class="text-xs text-emerald-200">
                                        <span class="text-green-300">+@_importPreview.NewBudgetCategories @L["New"]</span>
                                        @if (_importPreview.ExistingBudgetCategories > 0) { <span> · @_importPreview.ExistingBudgetCategories @L["Existing"]</span> }
                                    </p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3">
                                    <p class="text-emerald-200">@L["Snapshots"]</p>
                                    <p class="text-lg font-bold">@_importPreview.TotalSnapshots</p>
                                    <p class="text-xs text-emerald-200">
                                        <span class="text-green-300">+@_importPreview.NewSnapshots @L["New"]</span>
                                        @if (_importPreview.ExistingSnapshots > 0) { <span> · @_importPreview.ExistingSnapshots @L["Existing"]</span> }
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Import Options -->
                            <div class="mt-4 space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" @bind="_replaceExisting" class="w-5 h-5 rounded border-white/30 bg-white/10 text-emerald-400 focus:ring-emerald-400" />
                                    <span class="text-sm">@L["ReplaceExisting"]</span>
                                </label>
                            </div>
                        }
                    </div>
                    
                    <div class="flex gap-3">
                        @if (_importPreview.IsValid)
                        {
                            <button @onclick="ExecuteImport" disabled="@_isImporting" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-emerald-50 transition-all disabled:opacity-50">
                                @if (_isImporting)
                                {
                                    <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>@L["Importing"]...</span>
                                }
                                else
                                {
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>@L["ConfirmImport"]</span>
                                }
                            </button>
                        }
                        <button @onclick="CancelImport" class="px-4 py-3 bg-white/20 text-white font-semibold rounded-xl hover:bg-white/30 transition-all">
                            @L["Cancel"]
                        </button>
                    </div>
                }
                
                @if (_importResult != null)
                {
                    <!-- Result -->
                    <div class="@(_importResult.Success ? "bg-white/10" : "bg-red-500/20") rounded-xl p-4">
                        @if (_importResult.Success)
                        {
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-full bg-green-400 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold">@L["ImportSuccess"]</p>
                                    <p class="text-sm text-emerald-200">@L["ImportSuccessDesc"]</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-center text-sm">
                                <div class="bg-white/10 rounded-lg p-2">
                                    <p class="text-lg font-bold">@_importResult.AccountsImported</p>
                                    <p class="text-xs text-emerald-200">@L["Accounts"]</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <p class="text-lg font-bold">@_importResult.PortfoliosImported</p>
                                    <p class="text-xs text-emerald-200">@L["Portfolios"]</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <p class="text-lg font-bold">@_importResult.GoalsImported</p>
                                    <p class="text-xs text-emerald-200">@L["Goals"]</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <p class="text-lg font-bold">@_importResult.BudgetCategoriesImported</p>
                                    <p class="text-xs text-emerald-200">@L["BudgetCategories"]</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <p class="text-lg font-bold">@_importResult.SnapshotsImported</p>
                                    <p class="text-xs text-emerald-200">@L["Snapshots"]</p>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-red-400 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold">@L["ImportError"]</p>
                                    <p class="text-sm">@_importResult.Error</p>
                                </div>
                            </div>
                        }
                    </div>
                    <button @onclick="ResetImport" class="mt-3 w-full px-4 py-3 bg-white/20 text-white font-semibold rounded-xl hover:bg-white/30 transition-all">
                        @L["Close"]
                    </button>
                }
            </div>
            
            <!-- Export Section Header -->
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">@L["ExportData"]</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Full Backup -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">@L["FullBackup"]</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@L["FullBackupDesc"]</p>
                        </div>
                    </div>
                    <button @onclick="ExportFullBackup" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        @L["DownloadJson"]
                    </button>
                </div>

                <!-- Snapshots CSV -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">@L["SnapshotsCsv"]</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@L["SnapshotsCsvDesc"]</p>
                        </div>
                    </div>
                    <button @onclick="ExportCsv" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        @L["DownloadCsv"]
                    </button>
                </div>

                <!-- Investments CSV -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">@L["InvestmentsCsv"]</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@L["InvestmentsCsvDesc"]</p>
                        </div>
                    </div>
                    <button @onclick="ExportInvestmentsCsv" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        @L["DownloadCsv"]
                    </button>
                </div>

                <!-- Goals CSV -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">@L["GoalsCsv"]</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@L["GoalsCsvDesc"]</p>
                        </div>
                    </div>
                    <button @onclick="ExportGoalsCsv" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        @L["DownloadCsv"]
                    </button>
                </div>
            </div>
            
            <!-- Export Info -->
            <div class="mt-6 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <p class="font-medium text-gray-700 dark:text-gray-300 mb-1">@L["ExportTip"]</p>
                        <p>@L["ExportTipDesc"]</p>
                    </div>
                </div>
            </div>
        </div>
    }
}

<style>
    .tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.75rem;
        color: #6b7280;
        background-color: white;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
    }
    
    :global(.dark) .tab-btn {
        background-color: #111827;
        border-color: #374151;
        color: #9ca3af;
    }
    
    .tab-btn:hover {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    :global(.dark) .tab-btn:hover {
        background-color: #1f2937;
        color: #e5e7eb;
    }
    
    .tab-btn-active {
        background: linear-gradient(135deg, #6366f1, #4f46e5) !important;
        color: white !important;
        border-color: transparent !important;
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
    }
</style>

@code {
    string Tab = "dash";
    Snapshot? _latest;
    Totals _t = new(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    object _trendConfig = new { }, _compConfig = new { }, _invPieConfig = new { }, _intBarConfig = new { };
    HashSet<int?> _expandedPortfolios = new(); // Track expanded portfolios (null = "No Portfolio")
    
    // Budget state
    BudgetSummary? _budgetSummary;
    
    // Goals for dashboard widget
    List<Goal>? _goals;
    
    // Import state
    ImportPreview? _importPreview;
    ImportResult? _importResult;
    bool _replaceExisting = false;
    bool _isImporting = false;
    bool _showImportPanel = false;
    int _familyId;
    
    void TogglePortfolio(int? portfolioId)
    {
        if (_expandedPortfolios.Contains(portfolioId))
            _expandedPortfolios.Remove(portfolioId);
        else
            _expandedPortfolios.Add(portfolioId);
    }

    protected override async Task OnInitializedAsync()
    {
        // Get current user's FamilyId
        var authState = await AuthState.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            var user = await Auth.GetUserWithFamilyAsync(userId);
            if (user != null)
            {
                _familyId = user.FamilyId;
            }
        }
        
        _latest = await Finance.GetLatestSnapshotAsync(_familyId);
        if (_latest != null)
        {
            _t = await Finance.CalculateTotalsAsync(_latest);
            _budgetSummary = await Finance.GetBudgetSummaryAsync(_latest.Id, _familyId);
            _goals = (await Finance.GetGoalsAsync(_familyId)).OrderByDescending(g => g.Priority).ThenBy(g => g.ProgressPercent).ToList();
            await BuildCharts();
        }
    }

    async Task BuildCharts()
    {
        // OPTIMIZED: Single query instead of N+1
        var summaries = await Finance.GetSnapshotsWithTotalsAsync(_familyId);
        var full = summaries.Select(s => (d: s.Date.ToString("MM/yy"), v: s.GrandTotal)).ToList();

        _trendConfig = new
        {
            type = "line",
            data = new
            {
                labels = full.Select(x => x.d),
                datasets = new[] { new { label = L["ChartTotal"].Value, data = full.Select(x => x.v), borderColor = "#6366f1", backgroundColor = "rgba(99, 102, 241, 0.1)", fill = true, tension = 0.4 } }
            },
            options = new { responsive = true, maintainAspectRatio = false, plugins = new { legend = new { display = false } } }
        };
        
        _compConfig = new
        {
            type = "doughnut",
            data = new
            {
                labels = new[] { L["ChartLiquidity"].Value, L["ChartInvestments"].Value, L["ChartCredits"].Value, L["ChartPension"].Value },
                datasets = new[] { new { data = new[] { _t.Liquidity, _t.InvestmentsValue, _t.CreditsOpen, _t.PensionInsuranceValue }, backgroundColor = new[] { "#6366f1", "#06b6d4", "#f59e0b", "#10b981" } } }
            },
            options = new { responsive = true, maintainAspectRatio = false, plugins = new { legend = new { position = "bottom" } } }
        };
        
        _invPieConfig = new
        {
            type = "pie",
            data = new
            {
                labels = _latest!.Investments.Select(x => x.Name),
                datasets = new[] { new { data = _latest.Investments.Select(x => x.Value), backgroundColor = new[] { "#6366f1", "#06b6d4", "#f59e0b", "#10b981", "#ef4444", "#8b5cf6" } } }
            },
            options = new { responsive = true, maintainAspectRatio = false }
        };

        var intLines = _latest.Lines.Where(l => l.Account.IsInterest).ToList();
        _intBarConfig = new
        {
            type = "bar",
            data = new
            {
                labels = intLines.Select(x => x.Account.Name),
                datasets = new[] { new { label = L["ChartInterests"].Value, data = intLines.Select(x => x.Amount), backgroundColor = "#10b981" } }
            },
            options = new { responsive = true, maintainAspectRatio = false }
        };
    }

    async Task ExportFullBackup()
    {
        try
        {
            var snapshots = await Finance.GetSnapshotsAsync(_familyId);
            var fullSnapshots = new List<object>();
            foreach (var s in snapshots) 
            { 
                var snap = await Finance.GetSnapshotAsync(s.Id); 
                if (snap != null)
                {
                    fullSnapshots.Add(new
                    {
                        snap.Id,
                        Date = snap.SnapshotDate.ToString("yyyy-MM-dd"),
                        Lines = snap.Lines.Select(l => new { l.AccountId, AccountName = l.Account.Name, l.Amount, l.ContributionBasis }),
                        Investments = snap.Investments.Select(i => new { i.Name, i.CostBasis, i.Value, i.PortfolioId, PortfolioName = i.Portfolio?.Name }),
                        Receivables = snap.Receivables.Select(r => new { r.Description, r.Amount, Status = r.Status.ToString() }),
                        MonthlyExpenses = snap.Expenses.Select(e => new { e.CategoryId, CategoryName = e.Category?.Name, e.Amount })
                    });
                }
            }
            
            var accounts = await Finance.GetAccountsAsync(_familyId);
            var goals = await Finance.GetGoalsAsync(_familyId);
            var portfolios = await Finance.GetPortfoliosAsync(_familyId);
            var budgetCategories = await Finance.GetBudgetCategoriesAsync(_familyId);
            
            var backup = new 
            { 
                ExportDate = DateTime.UtcNow,
                Version = "2.1",
                Accounts = accounts.Select(a => new { a.Id, a.Name, Category = a.Category.ToString(), a.Owner, a.IsInterest, a.IsActive }),
                Portfolios = portfolios.Select(p => new { p.Id, p.Name, p.Description, p.TimeHorizonYears, p.TargetYear, p.Color, p.IsActive }),
                Goals = goals.Select(g => new { g.Id, g.Name, g.Target, g.AllocatedAmount, Deadline = g.DeadlineDisplay, Priority = g.Priority.ToString(), Category = g.Category.ToString(), g.ShowMonthlyTarget }),
                BudgetCategories = budgetCategories.Select(b => new { b.Id, b.Name, b.Icon, b.Color, b.MonthlyBudget, b.IsActive }),
                Snapshots = fullSnapshots
            };
            
            var options = new JsonSerializerOptions { WriteIndented = true };
            var json = JsonSerializer.Serialize(backup, options);
            var filename = $"familyfinance_backup_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            await JS.InvokeVoidAsync("downloadFile", filename, "application/json", Convert.ToBase64String(Encoding.UTF8.GetBytes(json)));
            
            Toast.ShowSuccess(L["ExportCompleted"].Value);
        }
        catch (Exception ex)
        {
            Toast.ShowError(L["ExportFailed"].Value + ": " + ex.Message);
        }
    }

    async Task ExportCsv()
    {
        try
        {
            // OPTIMIZED: Single query instead of N+1
            var summaries = await Finance.GetSnapshotsWithTotalsAsync(_familyId);
            var sb = new StringBuilder();
            sb.AppendLine("Data,Liquidità,Interessi,Investimenti Costo,Investimenti Valore,Investimenti G/L,Crediti,Previdenza Contributi,Previdenza Valore,Previdenza G/L,Totale Corrente,Totale Proiettato,Patrimonio Netto");
            
            foreach (var s in summaries)
            {
                sb.AppendLine($"{s.Date:yyyy-MM-dd},{s.Liquidity},{s.InterestLiquidity},{s.InvestmentsCost},{s.InvestmentsValue},{s.InvestmentsGainLoss},{s.CreditsOpen},{s.PensionInsuranceContrib},{s.PensionInsuranceValue},{s.PensionInsuranceGainLoss},{s.CurrentTotal},{s.ProjectedTotal},{s.GrandTotal}");
            }
            
            var filename = $"snapshots_{DateTime.Now:yyyyMMdd}.csv";
            await JS.InvokeVoidAsync("downloadFile", filename, "text/csv;charset=utf-8", Convert.ToBase64String(Encoding.UTF8.GetBytes(sb.ToString())));
            
            Toast.ShowSuccess(L["ExportCompleted"].Value);
        }
        catch (Exception ex)
        {
            Toast.ShowError(L["ExportFailed"].Value + ": " + ex.Message);
        }
    }

    async Task ExportInvestmentsCsv()
    {
        try
        {
            var all = await Finance.GetSnapshotsAsync(_familyId);
            var sb = new StringBuilder();
            sb.AppendLine("Data,Portafoglio,Asset,Costo Carico,Valore,Guadagno/Perdita,Performance %");
            
            foreach (var s in all.OrderBy(x => x.SnapshotDate))
            {
                var sn = await Finance.GetSnapshotAsync(s.Id);
                if (sn == null) continue;
                
                foreach (var inv in sn.Investments)
                {
                    var gl = inv.Value - inv.CostBasis;
                    var pct = inv.CostBasis > 0 ? (gl / inv.CostBasis) * 100 : 0;
                    var portfolioName = inv.Portfolio?.Name ?? "Non categorizzato";
                    sb.AppendLine($"{s.SnapshotDate:yyyy-MM-dd},{portfolioName},{inv.Name},{inv.CostBasis},{inv.Value},{gl},{pct:F2}");
                }
            }
            
            var filename = $"investments_{DateTime.Now:yyyyMMdd}.csv";
            await JS.InvokeVoidAsync("downloadFile", filename, "text/csv;charset=utf-8", Convert.ToBase64String(Encoding.UTF8.GetBytes(sb.ToString())));
            
            Toast.ShowSuccess(L["ExportCompleted"].Value);
        }
        catch (Exception ex)
        {
            Toast.ShowError(L["ExportFailed"].Value + ": " + ex.Message);
        }
    }

    async Task ExportGoalsCsv()
    {
        try
        {
            var goals = await Finance.GetGoalsAsync(_familyId);
            var sb = new StringBuilder();
            sb.AppendLine("Nome,Target,Allocato,Mancante,Progresso %,Scadenza,Priorità,Completato");
            
            foreach (var g in goals.OrderBy(x => x.Priority).ThenBy(x => x.Deadline))
            {
                var completed = g.IsCompleted ? "Sì" : "No";
                var priority = g.Priority.ToString();
                sb.AppendLine($"{g.Name},{g.Target},{g.AllocatedAmount},{g.Missing},{g.ProgressPercent:F1},{g.DeadlineDisplay},{priority},{completed}");
            }
            
            var filename = $"goals_{DateTime.Now:yyyyMMdd}.csv";
            await JS.InvokeVoidAsync("downloadFile", filename, "text/csv;charset=utf-8", Convert.ToBase64String(Encoding.UTF8.GetBytes(sb.ToString())));
            
            Toast.ShowSuccess(L["ExportCompleted"].Value);
        }
        catch (Exception ex)
        {
            Toast.ShowError(L["ExportFailed"].Value + ": " + ex.Message);
        }
    }

    // Import methods
    async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
            {
                _importPreview = new ImportPreview { IsValid = false, Error = "Nessun file selezionato" };
                return;
            }

            // Read file content (max 10MB)
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var fileContent = await reader.ReadToEndAsync();

            if (string.IsNullOrEmpty(fileContent))
            {
                _importPreview = new ImportPreview { IsValid = false, Error = "File vuoto o non leggibile" };
                return;
            }

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var backup = JsonSerializer.Deserialize<BackupDto>(fileContent, options);
            
            if (backup == null)
            {
                _importPreview = new ImportPreview { IsValid = false, Error = "Formato file non valido" };
                return;
            }

            _importPreview = await Finance.PreviewImportAsync(backup, _familyId);
        }
        catch (JsonException ex)
        {
            _importPreview = new ImportPreview { IsValid = false, Error = $"Errore parsing JSON: {ex.Message}" };
        }
        catch (Exception ex)
        {
            _importPreview = new ImportPreview { IsValid = false, Error = ex.Message };
        }
        
        StateHasChanged();
    }

    async Task ExecuteImport()
    {
        if (_importPreview?.Data == null) return;
        
        _isImporting = true;
        StateHasChanged();
        
        try
        {
            _importResult = await Finance.ImportDataAsync(_importPreview.Data!, _replaceExisting, _familyId);
            _importPreview = null;
            
            // Refresh data
            if (_importResult.Success)
            {
                _latest = await Finance.GetLatestSnapshotAsync(_familyId);
                if (_latest != null)
                {
                    _t = await Finance.CalculateTotalsAsync(_latest);
                    await BuildCharts();
                }
            }
        }
        catch (Exception ex)
        {
            _importResult = new ImportResult { Success = false, Error = ex.Message };
        }
        finally
        {
            _isImporting = false;
        }
    }

    void CancelImport()
    {
        _importPreview = null;
        _replaceExisting = false;
    }

    void ResetImport()
    {
        _importResult = null;
        _replaceExisting = false;
    }
}
