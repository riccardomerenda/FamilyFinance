@page "/dashboard"
@attribute [Authorize]
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using FamilyFinance.Services
@using FamilyFinance.Components

@using static FamilyFinance.Components.GuidedTour
@using AccountModel = FamilyFinance.Models.Account
@inject ISnapshotService SnapshotService
@inject IGoalService GoalService
@inject IJSRuntime JS
@inject IStringLocalizer<SharedResource> L
@inject AuthenticationStateProvider AuthState
@inject FamilyFinance.Services.AuthService Auth
@inject NavigationManager Nav
@inject WizardStateService WizardState
@inject IInsightService InsightService
@inject NotificationService Toast
@inject IAccountService AccountService
@inject IMonthCloseService MonthCloseService
@inject FamilyFinance.Services.Interfaces.IAssetHoldingService AssetHoldingService

<PageTitle>@L["Dashboard"] - FamilyFinance</PageTitle>


<!-- Month Close Banner -->
@if (_monthToClose != null)
{
    <div class="mb-6 bg-indigo-600 rounded-xl p-4 text-white shadow-lg shadow-indigo-500/20 flex flex-col sm:flex-row items-center justify-between gap-4 animate-in slide-in-from-top-4">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h3 class="font-bold text-lg">@L["CloseMonth"] @_monthToClose.Value.ToString("MMMM yyyy")</h3>
                <p class="text-indigo-100 text-sm">@L["CloseMonthPrompt"]</p>
            </div>
        </div>
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <button @onclick="DismissMonthClose" class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-white hover:bg-white/10 rounded-lg transition-colors">
                @L["Later"]
            </button>
            <button @onclick="CloseMonth" disabled="@_closingMonth" class="flex-1 sm:flex-none px-4 py-2 text-sm font-bold bg-white text-indigo-600 hover:bg-indigo-50 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2">
                @if (_closingMonth)
                {
                    <svg class="animate-spin h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                }
                @L["ConfirmClose"]
            </button>
        </div>
    </div>
}

<!-- Monthly Wizard -->
<FamilyFinance.Components.Wizard.MonthlyWizard OnSaved="OnWizardSaved" />

<!-- Guided Tour -->
<GuidedTour TourId="dashboard-tour" Steps="_tourSteps" OnComplete="OnTourComplete" />

<!-- Credit Collection Dialog -->
<FamilyFinance.Components.Dashboard.CreditCollectionDialog 
    IsOpen="_showCollectDialog" 
    Credit="_selectedCredit" 
    Accounts="_liquidityAccounts"
    OnConfirm="OnCreditCollected"
    OnClose="() => _showCollectDialog = false" />

@if (_loading)
{
    <div class="flex items-center justify-center min-h-[60vh]">
        <div class="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
}
else if (_latest is null)
{
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary-500/20 to-accent-500/20 flex items-center justify-center mb-6 animate-in">
            <svg class="w-12 h-12 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">@L["NoDataMessage"]</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6">@L["CreateFirstSnapshot"]</p>
        
        <div class="flex flex-col sm:flex-row gap-4">
            <a href="snapshots/new" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                @L["NewSnapshot"]
            </a>
            
            <a href="/data" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all shadow-lg shadow-emerald-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                @L["ImportBackup"]
            </a>
        </div>
    </div>
}
else
{
    <!-- Insights (Compact) -->
    @if (_insights != null && _insights.Any())
    {
        <div class="mb-5 animate-in">
            <FamilyFinance.Components.Dashboard.InsightCard Insights="_insights" />
        </div>
    }

    <!-- Command Center (Compact Bar) -->
    <div class="mb-5 lg:mb-8 animate-in delay-1">
        <FamilyFinance.Components.Dashboard.CommandCenter 
            LatestSnapshot="_latest" 
            InvestmentsLastUpdated="_investmentsLastUpdated"
            OnCloseMonth="OpenWizardNew"
            OnEditMonth="OpenWizardEdit" />
    </div>

    <!-- Bento Grid Dashboard -->
    <div class="grid grid-cols-12 gap-5 lg:gap-8">
        
        <!-- HERO: Net Worth Card (Large) -->
        <div id="tour-total" class="col-span-12 lg:col-span-5 bento-card hero-gradient glow-primary p-6 lg:p-8 text-white animate-in">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <p class="text-white/70 text-sm font-medium uppercase tracking-wider">@L["NetWorthTotal"]</p>
                    <h2 class="text-4xl lg:text-5xl font-extrabold mt-2 money">@_t.ProjectedTotal.ToString("N0") €</h2>
                    <p class="text-white/60 text-sm mt-2">@L["LiquidityPlusInvestmentsCredits"]</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            @if (_t.PensionInsuranceValue > 0)
            {
                <div class="pt-4 border-t border-white/20">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span class="text-white/70 text-sm">@L["IncludingPension"]:</span>
                        <span class="font-bold money">@_t.GrandTotal.ToString("N0") €</span>
                    </div>
                </div>
            }
        </div>

        <!-- Liquidity Card -->
        <div class="col-span-6 lg:col-span-4 bento-card p-5 animate-in delay-1 cursor-pointer hover:scale-[1.02] transition-transform" @onclick='() => Nav.NavigateTo("/accounts")'>
            <div class="flex items-center gap-3 mb-4">
                <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">@L["ChartLiquidity"]</span>
            </div>
            <p class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white money">@_t.Liquidity.ToString("N0") €</p>
            <p class="text-xs text-gray-400 mt-1 money">+ @_t.InterestLiquidity.ToString("N0") € @L["ChartInterests"]</p>
        </div>

        <!-- Investments Card -->
        <div class="col-span-6 lg:col-span-3 bento-card p-5 animate-in delay-2 cursor-pointer hover:scale-[1.02] transition-transform" @onclick='() => Nav.NavigateTo("/investments")'>
            <div class="flex items-center gap-3 mb-4">
                <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">@L["ChartInvestments"]</span>
            </div>
            <p class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white money">@_t.InvestmentsValue.ToString("N0") €</p>
            <p class="text-xs mt-1 money @(_t.InvestmentsGainLoss >= 0 ? "text-emerald-500" : "text-red-500") font-medium">
                @(_t.InvestmentsGainLoss >= 0 ? "+" : "")@_t.InvestmentsGainLoss.ToString("N0") € (@(_t.InvestmentsGainLossPercent >= 0 ? "+" : "")@_t.InvestmentsGainLossPercent.ToString("N1")%)
            </p>
        </div>

        <!-- Trend Chart (Large) -->
        <div id="tour-chart" class="col-span-12 lg:col-span-8 bento-card p-5 lg:p-6 animate-in delay-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["WealthTrend"]</h3>
                <a href="/projections" class="text-xs font-medium text-primary-500 hover:text-primary-600 flex items-center gap-1">
                    @L["Projections"]
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
            <div class="h-56 lg:h-64">
                <Chart CanvasId="trend" Config="@_trendConfig" />
            </div>
        </div>

        <!-- Composition Donut -->
        <div class="col-span-12 lg:col-span-4 bento-card p-5 lg:p-6 animate-in delay-4">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["Composition"]</h3>
            <div class="h-48 lg:h-56">
                <Chart CanvasId="comp" Config="@_compConfig" />
            </div>
        </div>

        <!-- Cash Flow Chart -->
        <div class="col-span-12 bento-card p-5 lg:p-6 animate-in delay-4">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">@L["CashFlow"] <span class="text-sm font-normal text-gray-500">(@L["IncomeVsExpenses"])</span></h3>
            <div class="h-64">
                <Chart CanvasId="cashflow" Config="@_cashFlowConfig" />
            </div>
        </div>

        <!-- Goals Widget -->
        @if (_goals != null && _goals.Any())
        {
            var hasPension = _t.PensionInsuranceValue > 0;
            var hasInterests = _t.InterestLiquidity > 0;
            var goalsColSpan = 12;
            if (hasPension) goalsColSpan -= 3;
            if (hasInterests) goalsColSpan -= 3;
            if (goalsColSpan == 9 && !hasInterests) goalsColSpan = 9; // If only pension, 9+3=12
            if (goalsColSpan == 9 && !hasPension) goalsColSpan = 9; // If only interests, 9+3=12
            
            // On mobile/tablet, full width or half. On Desktop, dynamic.
            // If both pension & interests: Goals(6) + P(3) + I(3)
            // If one: Goals(9) + One(3)
            // If none: Goals(12)
            
            var goalsClass = $"col-span-12 lg:col-span-{goalsColSpan}";

            <div id="tour-goals" class="@goalsClass bento-card p-5 lg:p-6 animate-in delay-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["Goals"]</h3>
                    <a href="/goals" class="text-xs font-medium text-primary-500 hover:text-primary-600 flex items-center gap-1">
                        @L["Edit"]
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
                <div class="space-y-4">
                    @foreach (var goal in _goals.Take(3))
                    {
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">@goal.Name</span>
                                <span class="text-xs font-semibold @(goal.IsCompleted ? "text-emerald-500" : "text-gray-500 dark:text-gray-400")">
                                    @goal.ProgressPercent.ToString("N0")%
                                </span>
                            </div>
                            <div class="h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                <div class="h-full rounded-full progress-animated @(goal.IsCompleted ? "bg-gradient-to-r from-emerald-500 to-teal-400" : "bg-gradient-to-r from-primary-500 to-accent-500")" 
                                     style="width: @Math.Min(100, goal.ProgressPercent)%"></div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <span class="money">@goal.AllocatedAmount.ToString("N0") € / @goal.Target.ToString("N0") €</span>
                                @if (!goal.IsCompleted && goal.Deadline.HasValue)
                                {
                                    <span>@goal.DeadlineDisplay</span>
                                }
                                else if (goal.IsCompleted)
                                {
                                    <span class="text-emerald-500">✓ @L["GoalCompleted"]</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Pension & Insurance Mini Card -->
        @if (_t.PensionInsuranceValue > 0)
        {
            <div class="col-span-12 md:col-span-6 lg:col-span-3 bento-card p-5 animate-in delay-5 cursor-pointer hover:scale-[1.02] transition-transform" @onclick='() => Nav.NavigateTo("/pension")'>
                <div class="flex flex-col h-full justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">@L["PensionInsurance"]</span>
                            <p class="text-lg font-bold text-gray-900 dark:text-white money leading-tight">@_t.PensionInsuranceValue.ToString("N0") €</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-xs font-medium text-gray-400">@L["GainLoss"]</p>
                        <p class="text-xs @(_t.PensionInsuranceGainLoss >= 0 ? "text-emerald-500" : "text-red-500") font-bold">
                            @(_t.PensionInsuranceGainLoss >= 0 ? "+" : "")@_t.PensionInsuranceGainLoss.ToString("N0") €
                        </p>
                    </div>
                </div>
            </div>
        }

        <!-- Interests Mini Card -->
        @if (_t.InterestLiquidity > 0)
        {
            <div class="col-span-12 md:col-span-6 lg:col-span-3 bento-card p-5 animate-in delay-5 cursor-pointer hover:scale-[1.02] transition-transform" @onclick='() => Nav.NavigateTo("/interests")'>
                <div class="flex flex-col h-full justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-green-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">@L["AccumulatedInterests"]</span>
                            <p class="text-lg font-bold text-emerald-600 dark:text-emerald-400 money leading-tight">+@_t.InterestLiquidity.ToString("N0") €</p>
                        </div>
                    </div>
                     <div class="flex items-center justify-end pt-2 border-t border-gray-100 dark:border-gray-800">
                         <a href="/interests" class="text-xs text-primary-500 hover:text-primary-600 font-medium">@L["ViewDetails"] →</a>
                    </div>
                </div>
            </div>
        }

        <!-- Pending Credits -->
        @if (_latest!.Receivables.Any(x => x.Status == ReceivableStatus.Open))
        {
            <div class="col-span-12 bento-card p-5 lg:p-6 animate-in delay-5">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["PendingCredits"]</h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    @foreach (var r in _latest.Receivables.Where(x => x.Status == ReceivableStatus.Open))
                    {
                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border border-amber-100 dark:border-amber-800/30">
                            <div class="flex-1 min-w-0">
                                <span class="font-medium text-gray-700 dark:text-gray-300 text-sm block truncate">@r.Description</span>
                                <span class="text-lg font-bold text-amber-600 dark:text-amber-400 money">@r.Amount.ToString("N0") €</span>
                            </div>
                            <button @onclick="() => OpenCollectDialog(r)" class="ml-2 px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded-lg transition-colors flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                @L["CollectCredit"]
                            </button>
                        </div>
                    }
                </div>

            </div>
        }


    </div>
}

@code {
    private bool _loading = true;
    private bool _initialized = false; // Prevents double loading during prerendering
    private bool _usingLiveData = false; // Live Balance feature
    private Snapshot? _latest;
    private Totals _t = new(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    private DateTime? _monthToClose;
    private bool _closingMonth = false;
    
    private object _trendConfig = new { }, _compConfig = new { }, _cashFlowConfig = new { };
    private List<Goal>? _goals;
    private List<FamilyFinance.Services.Interfaces.Insight>? _insights;
    private int _familyId;
    
    // Tour steps - defined after L is available
    private List<TourStep> _tourSteps = new();


    
    private async Task CloseMonth()
    {
        if (_monthToClose == null) return;
        
        _closingMonth = true;
        var result = await MonthCloseService.CloseMonthAsync(_familyId, _monthToClose.Value.Year, _monthToClose.Value.Month);
        _closingMonth = false;
        
        if (result.Success)
        {
            Toast.ShowSuccess(L["SnapshotSaved"]);
            _monthToClose = null; // Hide banner
            await LoadDashboardData(); // Refresh data
        }
        else
        {
            Toast.ShowError("Error: " + string.Join(", ", result.Errors));
        }
    }
    
    private void DismissMonthClose()
    {
        _monthToClose = null;
    }

    private bool _showSaveToast = false;
    
    // Credit collection dialog state
    private bool _showCollectDialog = false;
    private Receivable? _selectedCredit;
    private List<AccountModel> _liquidityAccounts = new();
    private DateTime? _investmentsLastUpdated;

    protected override async Task OnInitializedAsync()
    {
        // Skip if already initialized (prevents double loading during prerendering)
        if (_initialized) return;
        _initialized = true;
        
        var authState = await AuthState.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            var appUser = await Auth.GetUserWithFamilyAsync(userId);
        if (appUser != null)
            {
                _familyId = appUser.FamilyId;
                
                // Check for month close
                _monthToClose = await MonthCloseService.GetMonthToCloseAsync(_familyId);
            }
        }
        
        await LoadDashboardData();
    }
    
    private async Task LoadDashboardData()
    {
        _latest = await SnapshotService.GetLatestAsync(_familyId);
        if (_latest != null)
        {
            _t = await SnapshotService.CalculateTotalsAsync(_latest);
            
            // Load liquidity, pension and insurance accounts for live balance
            var allAccounts = await AccountService.GetAllAsync(_familyId);
            _liquidityAccounts = allAccounts.Where(a => a.Category == AccountCategory.Liquidity && a.IsActive).ToList();
            var pensionAccounts = allAccounts.Where(a => (a.Category == AccountCategory.Pension || a.Category == AccountCategory.Insurance) && a.IsActive).ToList();
            
            // LIVE BALANCE OVERRIDE
            // If we have live accounts, use their CurrentBalance instead of the static snapshot lines
            if (_liquidityAccounts.Any() || pensionAccounts.Any())
            {
                var liveLiquidity = _liquidityAccounts.Any() ? _liquidityAccounts.Sum(a => a.CurrentBalance) : _t.Liquidity;
                var livePension = pensionAccounts.Any() ? pensionAccounts.Sum(a => a.CurrentBalance) : _t.PensionInsuranceValue;
                
                // Only override if we have data (or if we want to force live mode)
                // We create a new Totals record with updated Liquidity, Pension and recalculated totals
                _t = _t with 
                { 
                    Liquidity = liveLiquidity,
                    PensionInsuranceValue = livePension,
                    CurrentTotal = liveLiquidity + _t.InvestmentsValue + _t.CreditsOpen,
                    ProjectedTotal = liveLiquidity + _t.InvestmentsValue + _t.CreditsOpen,
                    GrandTotal = liveLiquidity + _t.InvestmentsValue + _t.CreditsOpen + livePension
                };
                
                _usingLiveData = true;
            }

            _goals = (await GoalService.GetAllAsync(_familyId)).OrderByDescending(g => g.Priority).ThenBy(g => g.ProgressPercent).ToList();
            _insights = await InsightService.GetInsightsAsync(_familyId, _t.GrandTotal);
            
            // Build charts with the updated _t
            await BuildCharts();
            
            // Load investments last updated date for Command Center
            var holdings = await AssetHoldingService.GetAllAsync(_familyId);
            if (holdings.Any())
            {
                _investmentsLastUpdated = holdings.Max(h => h.LastUpdated);
            }
        }
        
        _loading = false;
        
        // Check if we came from a successful save (will show toast in OnAfterRenderAsync)
        var uri = new Uri(Nav.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _showSaveToast = queryParams["saved"] == "true";
        
        // Initialize tour steps AFTER loading is complete so DOM elements exist
        if (_latest != null)
        {
            InitializeTourSteps();
            StateHasChanged(); // Trigger re-render so GuidedTour sees the steps
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _showSaveToast)
        {
            _showSaveToast = false;
            Toast.ShowSuccess(L["SnapshotSaved"]);
            StateHasChanged();
        }
    }
    
    private void InitializeTourSteps()
    {
        _tourSteps = new List<TourStep>
        {
            new TourStep
            {
                Title = L["TourWelcomeTitle"],
                Description = L["TourWelcomeDesc"],
                TargetSelector = "#tour-total",
                Placement = TooltipPlacement.Right
            },
            new TourStep
            {
                Title = L["TourTotalTitle"],
                Description = L["TourTotalDesc"],
                TargetSelector = "#tour-total",
                Placement = TooltipPlacement.Bottom
            },
            new TourStep
            {
                Title = L["TourChartTitle"],
                Description = L["TourChartDesc"],
                TargetSelector = "#tour-chart",
                Placement = TooltipPlacement.Bottom
            },
            new TourStep
            {
                Title = L["TourActionsTitle"],
                Description = L["TourActionsDesc"],
                TargetSelector = "#tour-actions",
                Placement = TooltipPlacement.Left
            },
            new TourStep
            {
                Title = L["TourSidebarTitle"],
                Description = L["TourSidebarDesc"],
                TargetSelector = "#sidebar-nav",
                Placement = TooltipPlacement.Right
            },
            new TourStep
            {
                Title = L["TourComplete"],
                Description = L["TourCompleteDesc"],
                TargetSelector = "#tour-total",
                Placement = TooltipPlacement.Bottom
            }
        };
    }
    
    private void OnTourComplete()
    {
        // Tour completed - could show a success message or trigger other actions
    }

    async Task BuildCharts()
    {
        var summaries = await SnapshotService.GetAllWithTotalsAsync(_familyId);
        var full = summaries.Select(s => (d: s.Date.ToString("MM/yy"), v: s.GrandTotal)).ToList();

        _trendConfig = new
        {
            type = "line",
            data = new
            {
                labels = full.Select(x => x.d),
                datasets = new[] { new { label = L["ChartTotal"].Value, data = full.Select(x => x.v), borderColor = "#6366f1", backgroundColor = "rgba(99, 102, 241, 0.1)", fill = true, tension = 0.4 } }
            },
            options = new { responsive = true, maintainAspectRatio = false, plugins = new { legend = new { display = false } } }
        };
        
        _compConfig = new
        {
            type = "doughnut",
            data = new
            {
                labels = new[] { L["ChartLiquidity"].Value, L["ChartInvestments"].Value, L["ChartCredits"].Value, L["ChartPension"].Value },
                datasets = new[] { new { data = new[] { _t.Liquidity, _t.InvestmentsValue, _t.CreditsOpen, _t.PensionInsuranceValue }, backgroundColor = new[] { "#6366f1", "#06b6d4", "#f59e0b", "#10b981" } } }
            },
            options = new { 
                responsive = true, 
                maintainAspectRatio = false, 
                plugins = new { 
                    legend = new { 
                        position = "bottom",
                        labels = new { font = new { size = 12 } } // Increased font size
                    } 
                } 
            }
        };

        _cashFlowConfig = new
        {
            type = "bar",
            data = new
            {
                labels = full.Select(x => x.d),
                datasets = new[] 
                { 
                    new { label = L["Incomes"].Value, data = summaries.Select(s => s.IncomeTotal), backgroundColor = "#10b981", borderRadius = 4, barPercentage = 0.6 },
                    new { label = L["MonthlyExpenses"].Value, data = summaries.Select(s => s.ExpenseTotal), backgroundColor = "#ef4444", borderRadius = 4, barPercentage = 0.6 }
                }
            },
            options = new { 
                responsive = true, 
                maintainAspectRatio = false, 
                scales = new { 
                    y = new { beginAtZero = true, grid = new { color = "rgba(107, 114, 128, 0.1)" } },
                    x = new { grid = new { display = false } }
                }
            }
        };
    }
    
    private void OpenWizardNew()
    {
        // Suggest the next month after the last snapshot, not today
        DateTime suggestedDate;
        if (_latest != null)
        {
            // Last day of the month after the last snapshot
            var nextMonth = _latest.SnapshotDate.AddMonths(1);
            suggestedDate = new DateTime(nextMonth.Year, nextMonth.Month, DateTime.DaysInMonth(nextMonth.Year, nextMonth.Month));
        }
        else
        {
            // No snapshots yet - use end of current month
            suggestedDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, DateTime.DaysInMonth(DateTime.Today.Year, DateTime.Today.Month));
        }
        
        WizardState.OpenNew(suggestedDate);
    }
    
    private void OpenWizardEdit()
    {
        if (_latest != null)
        {
            WizardState.OpenEdit(_latest.Id);
        }
    }
    
    private async Task OnWizardSaved()
    {
        // Reload data after wizard completes
        _loading = true;
        StateHasChanged();
        
        _latest = await SnapshotService.GetLatestAsync(_familyId);
        if (_latest != null)
        {
            _t = await SnapshotService.CalculateTotalsAsync(_latest);
            _goals = (await GoalService.GetAllAsync(_familyId)).OrderByDescending(g => g.Priority).ThenBy(g => g.ProgressPercent).ToList();
            await BuildCharts();
        }
        
        _loading = false;
        StateHasChanged();
    }
    
    private void OpenCollectDialog(Receivable credit)
    {
        _selectedCredit = credit;
        _showCollectDialog = true;
    }
    
    private async Task OnCreditCollected(int? targetAccountId)
    {
        if (_selectedCredit == null) return;
        
        var result = await SnapshotService.CollectReceivableAsync(_selectedCredit.Id, targetAccountId);
        
        _showCollectDialog = false;
        _selectedCredit = null;
        
        if (result.Success)
        {
            Toast.ShowSuccess(L["CreditCollectedSuccess"]);
            
            // Reload data
            _latest = await SnapshotService.GetLatestAsync(_familyId);
            if (_latest != null)
            {
                _t = await SnapshotService.CalculateTotalsAsync(_latest);
                await BuildCharts();
            }
            StateHasChanged();
        }
        else
        {
            Toast.ShowError(result.Error ?? L["GenericError"]);
        }
    }
}
