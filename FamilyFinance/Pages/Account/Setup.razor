@page "/Account/Setup"
@layout EmptyLayout
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Authorization
@using FamilyFinance.Services
@inject IAuthService Auth
@inject NavigationManager Nav
@inject IStringLocalizer<SharedResource> L
@inject IWebHostEnvironment Env

<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-600 via-teal-700 to-cyan-900 p-4">
    <div class="w-full max-w-md">
        <!-- Logo/Title -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 rounded-2xl bg-white/10 backdrop-blur flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-white">@L["WelcomeSetup"]</h1>
            <p class="text-emerald-200 mt-2">@L["SetupSubtitle"]</p>
        </div>

        <!-- Setup Card -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl p-8">
            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="mb-6 p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 text-sm">
                    @_error
                </div>
            }

            <form method="post" action="/Auth/Setup" id="setupForm">
                <!-- Step indicator -->
                <div class="flex items-center justify-center gap-2 mb-6">
                    <div class="w-8 h-8 rounded-full @(_step == 1 ? "bg-primary-500 text-white" : "bg-gray-200 dark:bg-gray-700 text-gray-500") flex items-center justify-center font-bold text-sm">1</div>
                    <div class="w-12 h-1 @(_step >= 2 ? "bg-primary-500" : "bg-gray-200 dark:bg-gray-700") rounded"></div>
                    <div class="w-8 h-8 rounded-full @(_step == 2 ? "bg-primary-500 text-white" : "bg-gray-200 dark:bg-gray-700 text-gray-500") flex items-center justify-center font-bold text-sm">2</div>
                </div>

                @if (_step == 1)
                {
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">@L["CreateFamily"]</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">@L["FamilyName"]</label>
                            <input @bind="_familyName" name="familyName"
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                placeholder="Es. Famiglia Rossi" />
                        </div>

                        <button type="button" @onclick="NextStep"
                            class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all">
                            @L["Continue"]
                        </button>
                    </div>
                }
                else
                {
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">@L["CreateAdminAccount"]</h2>
                    
                    <!-- Hidden field for family name -->
                    <input type="hidden" name="familyName" value="@_familyName" />
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">@L["YourName"]</label>
                            <input @bind="_displayName" name="displayName" required
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                placeholder="Es. Mario" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" @bind="_email" name="email" required
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                placeholder="nome@email.com" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                            <input type="password" @bind="_password" name="password" required minlength="6"
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                placeholder="Minimo 6 caratteri" />
                        </div>

                        <div class="flex gap-3">
                            <button type="button" @onclick="PrevStep"
                                class="px-4 py-3 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                                @L["Back"]
                            </button>
                            <button type="submit"
                                class="flex-1 py-3 px-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all">
                                @L["CompleteSetup"]
                            </button>
                        </div>
                    </div>
                }
            </form>
        </div>

        <!-- Info -->
        <div class="mt-6 p-4 rounded-xl bg-white/10 backdrop-blur">
            <div class="flex items-start gap-3 text-emerald-100 text-sm">
                <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p>@L["SetupInfo"]</p>
            </div>
        </div>
    </div>
</div>

@code {
    int _step = 1;
    string _familyName = "";
    string _displayName = "";
    string _email = "";
    string _password = "";
    string? _error;

    protected override async Task OnInitializedAsync()
    {
        // In production, disable registration - redirect to login
        if (!Env.IsDevelopment())
        {
            Nav.NavigateTo("/Account/Login");
            return;
        }
        
        // If users already exist, redirect to login
        if (await Auth.HasAnyUsersAsync())
        {
            Nav.NavigateTo("/Account/Login");
        }
    }

    void NextStep()
    {
        _error = null;
        if (string.IsNullOrWhiteSpace(_familyName))
        {
            _error = "Inserisci il nome della famiglia";
            return;
        }
        _step = 2;
    }

    void PrevStep()
    {
        _error = null;
        _step = 1;
    }
}
