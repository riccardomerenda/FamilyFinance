@page "/snapshots"
@using System.Security.Claims
@inject FinanceService Finance
@inject NavigationManager Nav
@inject IStringLocalizer<SharedResource> L
@inject AuthenticationStateProvider AuthState
@attribute [Authorize]

<div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">@L["SnapshotsHistory"]</h1>
    <a href="/snapshots/new" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/30">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        @L["NewSnapshot"]
    </a>
</div>

@if (_items == null)
{
    <div class="flex items-center justify-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
    </div>
}
else if (!_items.Any())
{
    <div class="text-center py-16">
        <div class="w-20 h-20 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        </div>
        <p class="text-gray-500 dark:text-gray-400">@L["NoDataMessage"]</p>
    </div>
}
else
{
    <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
        <div class="divide-y divide-gray-200 dark:divide-gray-800">
            @foreach (var s in _items)
            {
                <div class="flex items-center justify-between p-5 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center text-white font-bold">
                            @s.SnapshotDate.ToString("dd")
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-gray-200">@s.SnapshotDate.ToString("MMMM yyyy")</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@s.SnapshotDate.ToString("dddd")</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @onclick='() => Nav.NavigateTo($"/snapshots/{s.Id}")' class="px-4 py-2 text-sm font-medium text-primary-600 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg transition-colors">
                            @L["Open"]
                        </button>
                        <button @onclick="() => Delete(s.Id)" class="px-4 py-2 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                            @L["Delete"]
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    List<Snapshot>? _items;
    int _familyId;
    
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            var user = await Finance.Auth.GetUserWithFamilyAsync(userId);
            if (user != null) _familyId = user.FamilyId;
        }
        _items = await Finance.GetSnapshotsAsync(_familyId);
    }
    
    async Task Delete(int id)
    {
        await Finance.DeleteSnapshotAsync(id);
        _items = await Finance.GetSnapshotsAsync(_familyId);
    }
}
