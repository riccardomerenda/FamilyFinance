@page "/compare"
@using System.Security.Claims
@using FamilyFinance.Components
@using FamilyFinance.Services.Interfaces
@inject ISnapshotService Snapshots
@inject IAuthService Auth
@inject IStringLocalizer<SharedResource> L
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthState
@attribute [Authorize]

<div class="flex items-center justify-between mb-8 animate-in">
    <div>
        <div class="flex items-center gap-2">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">@L["MonthlyComparison"]</h1>
            <HelpTooltip Title="@L["Compare"]" Content="@L["HelpCompare"]" />
        </div>
        <p class="text-gray-500 dark:text-gray-400 mt-1">@L["CompareDescription"]</p>
    </div>
</div>

@if (_snapshots == null)
{
    <div class="bento-card flex items-center justify-center h-64 animate-in">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
    </div>
}
else if (_snapshots.Count < 2)
{
    <div class="bento-card text-center py-16 animate-in">
        <div class="w-20 h-20 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">@L["NeedTwoSnapshots"]</h3>
        <a href="/snapshots/new" class="text-primary-500 hover:text-primary-600 font-medium">@L["CreateSnapshot"] →</a>
    </div>
}
else
{
    <!-- Date Selectors -->
    <div class="bento-card p-6 mb-6 animate-in delay-1">
        <div class="flex flex-col md:flex-row items-center justify-center gap-4">
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">@L["From"]:</span>
                <select @bind="_selectedFrom" @bind:after="OnSelectionChanged" class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500">
                    @foreach (var s in _snapshots.OrderBy(x => x.SnapshotDate))
                    {
                        <option value="@s.Id">@s.SnapshotDate.ToString("MMMM yyyy")</option>
                    }
                </select>
            </div>
            
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">@L["To"]:</span>
                <select @bind="_selectedTo" @bind:after="OnSelectionChanged" class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500">
                    @foreach (var s in _snapshots.OrderBy(x => x.SnapshotDate))
                    {
                        <option value="@s.Id">@s.SnapshotDate.ToString("MMMM yyyy")</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @if (_comparison != null)
    {
        <!-- Summary Cards with Bento Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Total Patrimony -->
            <div class="bento-card p-6 hero-gradient text-white animate-in delay-2">
                <p class="text-sm text-white/80 mb-2">@L["NetWorthTotal"]</p>
                <p class="text-3xl font-bold money">@_comparison.ToTotal.ToString("N0") €</p>
                <p class="text-xs text-white/60 mt-2">@_comparison.ToDate.ToString("MMMM yyyy")</p>
            </div>
            
            <!-- Variation -->
            <div class="bento-card p-6 animate-in delay-3">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">@L["Variation"]</p>
                <p class="text-3xl font-bold money @(_comparison.TotalDelta >= 0 ? "text-emerald-500" : "text-red-500")">
                    @(_comparison.TotalDelta >= 0 ? "+" : "")@_comparison.TotalDelta.ToString("N0") €
                </p>
                <div class="flex items-center gap-2 mt-2">
                    @if (_comparison.TotalDelta >= 0)
                    {
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    }
                    else
                    {
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0v-8m0 8l-8-8-4 4-6-6"></path>
                        </svg>
                    }
                    <span class="text-sm text-gray-500">@L["AbsoluteChange"]</span>
                </div>
            </div>
            
            <!-- Percentage -->
            <div class="bento-card p-6 animate-in delay-4">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">@L["GrowthRate"]</p>
                <p class="text-3xl font-bold @(_comparison.TotalDeltaPercent >= 0 ? "text-emerald-500" : "text-red-500")">
                    @(_comparison.TotalDeltaPercent >= 0 ? "+" : "")@_comparison.TotalDeltaPercent.ToString("F1")%
                </p>
                <p class="text-xs text-gray-400 mt-1">
                    @_comparison.MonthsDiff @L["Months"]
                </p>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">@L["CategoryComparison"]</h3>
            <div class="h-64">
                <Chart CanvasId="compareChart" Config="@_chartConfig" />
            </div>
        </div>

        <!-- What Changed -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Increases -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["Increases"]</h3>
                </div>
                
                @if (_comparison.Increases.Any())
                {
                    <div class="space-y-3">
                        @foreach (var item in _comparison.Increases.OrderByDescending(x => x.Delta).Take(10))
                        {
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">@item.Name</span>
                                <span class="text-sm font-medium text-emerald-500">+@item.Delta.ToString("N0") €</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-sm text-gray-400">@L["NoIncreases"]</p>
                }
            </div>
            
            <!-- Decreases -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0v-8m0 8l-8-8-4 4-6-6"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["Decreases"]</h3>
                </div>
                
                @if (_comparison.Decreases.Any())
                {
                    <div class="space-y-3">
                        @foreach (var item in _comparison.Decreases.OrderBy(x => x.Delta).Take(10))
                        {
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">@item.Name</span>
                                <span class="text-sm font-medium text-red-500">@item.Delta.ToString("N0") €</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-sm text-gray-400">@L["NoDecreases"]</p>
                }
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden mb-6">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["DetailedComparison"]</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@L["Category"]</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@_comparison.FromDate.ToString("MMM yyyy")</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@_comparison.ToDate.ToString("MMM yyyy")</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@L["Delta"]</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">%</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                        @foreach (var row in _comparison.CategoryRows)
                        {
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">@row.Name</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600 dark:text-gray-400">
                                    @row.FromValue.ToString("N0") €
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600 dark:text-gray-400">
                                    @row.ToValue.ToString("N0") €
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <span class="text-sm font-medium @(row.Delta >= 0 ? "text-emerald-500" : "text-red-500")">
                                        @(row.Delta >= 0 ? "+" : "")@row.Delta.ToString("N0") €
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <span class="text-sm @(row.DeltaPercent >= 0 ? "text-emerald-500" : "text-red-500")">
                                        @(row.DeltaPercent >= 0 ? "+" : "")@row.DeltaPercent.ToString("F1")%
                                    </span>
                                </td>
                            </tr>
                        }
                        <!-- Total Row -->
                        <tr class="bg-gray-50 dark:bg-gray-800/50 font-semibold">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">@L["Total"]</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900 dark:text-gray-100">@_comparison.FromTotal.ToString("N0") €</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900 dark:text-gray-100">@_comparison.ToTotal.ToString("N0") €</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="text-sm @(_comparison.TotalDelta >= 0 ? "text-emerald-600" : "text-red-600")">
                                    @(_comparison.TotalDelta >= 0 ? "+" : "")@_comparison.TotalDelta.ToString("N0") €
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="text-sm @(_comparison.TotalDeltaPercent >= 0 ? "text-emerald-600" : "text-red-600")">
                                    @(_comparison.TotalDeltaPercent >= 0 ? "+" : "")@_comparison.TotalDeltaPercent.ToString("F1")%
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Account Details -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">@L["AccountDetails"]</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@L["Account"]</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@L["Category"]</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@_comparison.FromDate.ToString("MMM yyyy")</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@_comparison.ToDate.ToString("MMM yyyy")</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">@L["Delta"]</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                        @foreach (var row in _comparison.AccountRows.OrderBy(x => x.Category).ThenBy(x => x.Name))
                        {
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">@row.Name</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">@L[row.Category]</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600 dark:text-gray-400">@row.FromValue.ToString("N0") €</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600 dark:text-gray-400">@row.ToValue.ToString("N0") €</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <span class="text-sm font-medium @(row.Delta >= 0 ? "text-emerald-500" : "text-red-500")">
                                        @(row.Delta >= 0 ? "+" : "")@row.Delta.ToString("N0") €
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    List<Snapshot>? _snapshots;
    int _selectedFrom;
    int _selectedTo;
    int _familyId;
    ComparisonResult? _comparison;
    object? _chartConfig;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            var user = await Auth.GetUserWithFamilyAsync(userId);
            if (user != null) _familyId = user.FamilyId;
        }

        _snapshots = await Snapshots.GetAllAsync(_familyId);
        
        if (_snapshots.Count >= 2)
        {
            var ordered = _snapshots.OrderByDescending(x => x.SnapshotDate).ToList();
            _selectedTo = ordered[0].Id;
            _selectedFrom = ordered[1].Id;
            await CalculateComparison();
        }
    }

    async Task OnSelectionChanged()
    {
        await CalculateComparison();
    }

    async Task CalculateComparison()
    {
        if (_selectedFrom == 0 || _selectedTo == 0 || _selectedFrom == _selectedTo)
            return;

        var fromSnapshot = await Snapshots.GetByIdAsync(_selectedFrom);
        var toSnapshot = await Snapshots.GetByIdAsync(_selectedTo);

        if (fromSnapshot == null || toSnapshot == null)
            return;

        var fromTotals = await Snapshots.CalculateTotalsAsync(fromSnapshot);
        var toTotals = await Snapshots.CalculateTotalsAsync(toSnapshot);

        // Ensure from is before to
        if (fromSnapshot.SnapshotDate > toSnapshot.SnapshotDate)
        {
            (fromSnapshot, toSnapshot) = (toSnapshot, fromSnapshot);
            (fromTotals, toTotals) = (toTotals, fromTotals);
        }

        var monthsDiff = ((toSnapshot.SnapshotDate.Year - fromSnapshot.SnapshotDate.Year) * 12) + 
                         toSnapshot.SnapshotDate.Month - fromSnapshot.SnapshotDate.Month;

        _comparison = new ComparisonResult
        {
            FromDate = fromSnapshot.SnapshotDate,
            ToDate = toSnapshot.SnapshotDate,
            MonthsDiff = monthsDiff,
            FromTotal = fromTotals.GrandTotal,
            ToTotal = toTotals.GrandTotal,
            TotalDelta = toTotals.GrandTotal - fromTotals.GrandTotal,
            TotalDeltaPercent = fromTotals.GrandTotal != 0 
                ? ((toTotals.GrandTotal - fromTotals.GrandTotal) / fromTotals.GrandTotal) * 100 
                : 0
        };

        // Category rows
        _comparison.CategoryRows = new List<ComparisonRow>
        {
            new("Liquidity", fromTotals.Liquidity, toTotals.Liquidity),
            new("Investments", fromTotals.InvestmentsValue, toTotals.InvestmentsValue),
            new("Credits", fromTotals.CreditsOpen, toTotals.CreditsOpen),
            new("PensionInsurance", fromTotals.PensionInsuranceValue, toTotals.PensionInsuranceValue)
        };

        // Account rows
        var allAccountIds = fromSnapshot.Lines.Select(l => l.AccountId)
            .Union(toSnapshot.Lines.Select(l => l.AccountId))
            .Distinct();

        _comparison.AccountRows = new List<AccountComparisonRow>();
        foreach (var accountId in allAccountIds)
        {
            var fromLine = fromSnapshot.Lines.FirstOrDefault(l => l.AccountId == accountId);
            var toLine = toSnapshot.Lines.FirstOrDefault(l => l.AccountId == accountId);
            var account = fromLine?.Account ?? toLine?.Account;
            
            if (account != null)
            {
                _comparison.AccountRows.Add(new AccountComparisonRow(
                    account.Name,
                    account.Category.ToString(),
                    fromLine?.Amount ?? 0,
                    toLine?.Amount ?? 0
                ));
            }
        }

        // Investment rows
        var allInvestments = fromSnapshot.Investments.Select(i => i.Name)
            .Union(toSnapshot.Investments.Select(i => i.Name))
            .Distinct();

        foreach (var name in allInvestments)
        {
            var fromInv = fromSnapshot.Investments.FirstOrDefault(i => i.Name == name);
            var toInv = toSnapshot.Investments.FirstOrDefault(i => i.Name == name);
            
            _comparison.AccountRows.Add(new AccountComparisonRow(
                name,
                "Investments",
                fromInv?.Value ?? 0,
                toInv?.Value ?? 0
            ));
        }

        // Increases and decreases
        _comparison.Increases = _comparison.AccountRows.Where(r => r.Delta > 0)
            .Select(r => new DeltaItem(r.Name, r.Delta)).ToList();
        _comparison.Decreases = _comparison.AccountRows.Where(r => r.Delta < 0)
            .Select(r => new DeltaItem(r.Name, r.Delta)).ToList();

        // Build chart
        BuildChart();
    }

    void BuildChart()
    {
        if (_comparison == null) return;

        var labels = _comparison.CategoryRows.Select(r => L[r.Name].Value).ToArray();
        var fromData = _comparison.CategoryRows.Select(r => r.FromValue).ToArray();
        var toData = _comparison.CategoryRows.Select(r => r.ToValue).ToArray();

        _chartConfig = new
        {
            type = "bar",
            data = new
            {
                labels,
                datasets = new[]
                {
                    new { 
                        label = _comparison.FromDate.ToString("MMM yyyy"), 
                        data = fromData, 
                        backgroundColor = "rgba(99, 102, 241, 0.7)",
                        borderColor = "rgb(99, 102, 241)",
                        borderWidth = 1
                    },
                    new { 
                        label = _comparison.ToDate.ToString("MMM yyyy"), 
                        data = toData, 
                        backgroundColor = "rgba(16, 185, 129, 0.7)",
                        borderColor = "rgb(16, 185, 129)",
                        borderWidth = 1
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new
                {
                    legend = new { position = "top" }
                },
                scales = new
                {
                    y = new { beginAtZero = true }
                }
            }
        };
    }

    // Data classes
    class ComparisonResult
    {
        public DateOnly FromDate { get; set; }
        public DateOnly ToDate { get; set; }
        public int MonthsDiff { get; set; }
        public decimal FromTotal { get; set; }
        public decimal ToTotal { get; set; }
        public decimal TotalDelta { get; set; }
        public decimal TotalDeltaPercent { get; set; }
        public List<ComparisonRow> CategoryRows { get; set; } = new();
        public List<AccountComparisonRow> AccountRows { get; set; } = new();
        public List<DeltaItem> Increases { get; set; } = new();
        public List<DeltaItem> Decreases { get; set; } = new();
    }

    record ComparisonRow(string Name, decimal FromValue, decimal ToValue)
    {
        public decimal Delta => ToValue - FromValue;
        public decimal DeltaPercent => FromValue != 0 ? ((ToValue - FromValue) / FromValue) * 100 : 0;
    }

    record AccountComparisonRow(string Name, string Category, decimal FromValue, decimal ToValue)
    {
        public decimal Delta => ToValue - FromValue;
    }

    record DeltaItem(string Name, decimal Delta);
}

